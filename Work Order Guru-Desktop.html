<!DOCTYPE html>
<!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    WORK ORDER GURU DESKTOP - Professional Automotive Work Order Management
    CACHE BUSTER: 2025-11-09-15-47 - PRINT FIX APPLIED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    Copyright Â© 2025 Work Order Guru. All Rights Reserved.
    
    PROPRIETARY AND CONFIDENTIAL
    
    This software and associated documentation files (the "Software") are the 
    proprietary property of Work Order Guru and are protected by laws 
    and international treaty provisions.
    
    UNAUTHORIZED USE PROHIBITED:
    â€¢ No part of this Software may be reproduced, distributed, or transmitted
    â€¢ No derivative works may be created from this Software
    â€¢ No reverse engineering, decompilation, or disassembly is permitted
    â€¢ Copying, modifying, or selling this Software is strictly prohibited
    
    LICENSE REQUIRED:
    Use of this Software requires a valid license agreement. Unauthorized use,
    copying, modification, or distribution is a violation of applicable laws
    and will be prosecuted to the fullest extent.
    
    For licensing inquiries, contact: [Your Email/Website]
    
    THE SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.
    
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta na        /* F        #entries-dropdown {
            width: 100%;
            max-width: 850px;
            margin: 0 auto 10px auto;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: static;
            z-index: 99;
            margin-bottom: 16px;
        }
        
        /* Improved dropdown option styling - Dark Mode */
        #entries-dropdown option {
            padding: 10px 8px;
            line-height: 1.6;
            white-space: pre-line !important;
            text-transform: uppercase;
            background: #2d2d2d !important;
            color: #ffffff !important;
            min-height: 60px;
            font-size: 13px;
        }
        
        #entries-dropdown option:not(:first-child) {
            border-top: 1px solid #404040;
        }
        
        #entries-dropdown option:hover {
            background: #404040 !important;
        }
        
        #entries-dropdown option:selected {
            background: #555 !important;
        }tyles --- */
        #repair-order-form { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .form-field { 
            position: absolute; 
            z-index: 2; 
            box-sizing: border-box;
            /* Force hardware acceleration and proper rendering on Android */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            /* Ensure proper pointer events */
            pointer-events: auto;
        }wport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=3.0">
    <title>Work Order Guru</title>
    
    <!-- Favicon and PWA Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#333333">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="WO Guru">
    
    <!-- Barcode Scanner Library for Camera-based VIN scanning -->
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        #firebase-status {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 5px;
            background-color: #ffc107; /* Yellow for connecting */
            color: black;
            text-align: center;
            font-size: 12px;
            z-index: 100;
            font-weight: bold;
        }
        #firebase-status.connected {
            background-color: #28a745; /* Green for connected */
            color: white;
        }
        #firebase-status.disconnected {
            background-color: #dc3545; /* Red for disconnected */
            color: white;
        }
        
        /* Lock status indicator */
        #save-status.locked-readonly {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
            color: white !important;
            padding: 4px 12px;
            border-radius: 6px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3);
        }
        
        /* Force unlock button */
        #force-unlock-btn {
            display: none;
            background: linear-gradient(135deg, #ff9800 0%, #ff6f00 100%);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 8px;
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.4);
            transition: all 0.3s;
        }
        #force-unlock-btn:hover {
            background: linear-gradient(135deg, #ff6f00 0%, #ff9800 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.6);
        }
        
        /* Ensure text selection works properly (Firefox/Edge fix) */
        input, textarea, [contenteditable] {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        /* Prevent blur events from clearing selection */
        input::selection, textarea::selection, [contenteditable]::selection {
            background: #0078d4;
            color: white;
        }
        input::-moz-selection, textarea::-moz-selection, [contenteditable]::-moz-selection {
            background: #0078d4;
            color: white;
        }
        #force-unlock-btn.visible {
            display: inline-block;
        }
        
        /* VIN Hover Overlay Styles */
        .vin-overlay {
            position: absolute;
            background: #fff;
            border: 2px solid #333;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10000;
            font-size: 18px;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            white-space: nowrap;
            pointer-events: none;
            display: none;
        }
        
        .vin-overlay.show {
            display: block;
        }
        
        .vin-first-part {
            font-weight: normal;
            color: #666;
        }
        
        .vin-last-eight {
            font-weight: bold;
            color: #000;
            font-size: 20px;
        }

        #bottom-bar {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-top: 1px solid #404040;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.6);
            z-index: 101;
            padding: 4px 0 4px 0;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        /* VIN Scanner Camera Styles */
        .scan-vin-btn {
            position: absolute;
            right: -28px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px !important;
            height: 24px !important;
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 255, 136, 0.3);
            transition: all 0.2s;
            z-index: 10;
        }
        .scan-vin-btn:hover {
            background: linear-gradient(135deg, #00cc6a 0%, #00ff88 100%);
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.5);
        }
        .scan-vin-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
        
        #scanner-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 9999;
            flex-direction: column;
        }
        #scanner-overlay.active {
            display: flex;
        }
        
        .scanner-header {
            width: 100%;
            padding: 15px 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #00ff88;
            flex-shrink: 0;
        }
        
        .scanner-title {
            color: #00ff88;
            font-size: 20px;
            font-weight: bold;
        }
        
        .scanner-close-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
        }
        .scanner-close-btn:active {
            background: #c82333;
        }
        
        #scanner-container {
            position: relative;
            flex: 1;
            width: 100%;
            min-height: 0;
            background: #000;
            overflow: hidden;
        }
        
        #scanner-video {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            overflow: hidden;
        }
        
        #scanner-video video {
            max-width: 100%;
            max-height: 100%;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        #scanner-video canvas {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: contain !important;
        }
        
        #scanner-video canvas.drawingBuffer {
            position: absolute !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            max-width: 100% !important;
            max-height: 100% !important;
            width: auto !important;
            height: auto !important;
        }
        
        .scanner-instructions {
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            color: #fff;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            border-top: 2px solid #00ff88;
            flex-shrink: 0;
        }
        
        @media (max-width: 900px) {
            .scanner-title {
                font-size: 18px;
            }
            .scanner-header {
                padding: 12px 15px;
            }
            .scanner-instructions {
                padding: 15px;
            }
        }
        #entries-list {
            width: 100%;
            max-width: 850px;
            margin: 0 auto 10px auto;
            padding: 4px;
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            border: 1px solid #404040;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            position: static;
            z-index: 99;
            margin-bottom: 4px;
        }
        
        /* Professional Button Styling - Dark Mode */
        .btn-professional {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            padding: 6px 12px;
            border: 1px solid;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
            margin-left: 4px;
            min-width: 80px;
            backdrop-filter: blur(10px);
        }
        
        .btn-professional:first-child {
            margin-left: 0;
        }
        
        .btn-professional:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
        }
        
        .btn-professional:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }
        
        /* Button Color Schemes - Dark Mode */
        #save-btn {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        
        #save-btn:hover {
            background: linear-gradient(135deg, #2d2d2d 0%, #404040 100%);
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
            color: #00ffaa;
        }
        
        #new-work-order-btn {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #8a2be2;
            border: 1px solid #8a2be2;
        }
        
        #new-work-order-btn:hover {
            background: linear-gradient(135deg, #2d2d2d 0%, #404040 100%);
            box-shadow: 0 4px 12px rgba(138, 43, 226, 0.3);
            color: #9932cc;
        }
        
        #new-order-btn {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #00bfff;
            border: 1px solid #00bfff;
        }
        
        #new-order-btn:hover {
            background: linear-gradient(135deg, #2d2d2d 0%, #404040 100%);
            box-shadow: 0 4px 12px rgba(0, 191, 255, 0.3);
            color: #1e90ff;
        }
        
        #print-btn {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ff6b35;
            border: 1px solid #ff6b35;
        }
        
        #print-btn:hover {
            background: linear-gradient(135deg, #2d2d2d 0%, #404040 100%);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            color: #ff7f50;
        }
        
        #delete-entry-btn {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ff4757;
            border: 1px solid #ff4757;
        }
        
        #delete-entry-btn:hover {
            background: linear-gradient(135deg, #2d2d2d 0%, #404040 100%);
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
            color: #ff6b7a;
        }
        
        /* Button shimmer effect - Dark Mode */
        .btn-professional::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s;
        }
        
        .btn-professional:hover::before {
            left: 100%;
        }
        
        /* Additional dark mode glow effect */
        .btn-professional::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 8px;
            background: inherit;
            z-index: -1;
            filter: blur(4px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .btn-professional:hover::after {
            opacity: 0.3;
        }
        
        /* Mobile bottom bar adjustments */
        @media (max-width: 900px) {
            #bottom-bar {
                padding: 4px 4px;
                position: fixed;
                background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
                border-top: 1px solid #404040;
            }
            #bottom-bar > div {
                padding: 0 4px;
            }
            #entry-search, #entries-dropdown {
                width: 85% !important;
                margin-bottom: 3px;
                font-size: 14px !important;
                padding: 6px 5px !important;
                border-radius: 4px;
                text-transform: uppercase;
                background: #2d2d2d !important;
                color: #ffffff !important;
                border: 1px solid #404040 !important;
            }
            #entry-search::placeholder {
                color: #888 !important;
            }
            #entries-dropdown option {
                padding: 3px 3px;
                line-height: 1.1;
                text-transform: uppercase;
                background: #2d2d2d !important;
                color: #ffffff !important;
            }
            .btn-professional {
                padding: 8px 12px !important;
                font-size: 13px !important;
                touch-action: manipulation;
                min-height: 36px;
                margin: 2px 1px !important;
                min-width: 100px;
            }
            body {
                padding-bottom: 140px; /* Minimal space for scaled container */
            }
            #save-status {
                display: block;
                margin-left: 0 !important;
                margin-top: 4px;
                text-align: center;
                color: #00ff88 !important;
                font-size: 12px;
            }
            #force-unlock-btn {
                display: block;
                width: 100%;
                margin-top: 8px;
            }
        }
        
        /* Android-Specific Performance Optimizations (Desktop unaffected) */
        @media (hover: none) and (pointer: coarse) {
            /* Touch device optimizations */
            * {
                -webkit-tap-highlight-color: rgba(0, 150, 255, 0.2);
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
            }
            
            input, textarea, [contenteditable] {
                -webkit-user-select: text;
                user-select: text;
            }
            
            /* Improve input responsiveness on Android */
            input, textarea, [contenteditable], select {
                touch-action: manipulation;
            }
            
            /* Better button tap areas */
            button, .btn-professional {
                min-height: 44px;
                min-width: 44px;
                touch-action: manipulation;
            }
            
            /* Smoother scrolling on Android */
            body, .container {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Hardware acceleration for form fields */
            .form-field {
                -webkit-transform: translate3d(0, 0, 0);
                transform: translate3d(0, 0, 0);
                will-change: transform;
            }
            
            /* Optimize scanner for mobile */
            #scanner-overlay {
                -webkit-transform: translate3d(0, 0, 0);
                transform: translate3d(0, 0, 0);
            }
            
            #scanner-video video {
                -webkit-transform: translate3d(0, 0, 0);
                transform: translate3d(0, 0, 0);
            }
        }
        
        /* Android Chrome specific optimizations */
        @supports (-webkit-touch-callout: none) {
            /* Safari/Chrome on iOS/Android */
            input[type="text"],
            input[type="number"],
            textarea,
            [contenteditable] {
                -webkit-appearance: none;
                appearance: none;
            }
        }
        
        /* Uppercase all text inputs and textareas */
        input[type="text"],
        textarea {
            text-transform: uppercase;
        }
        
        /* Prevent text selection issues on Android */
        @media (max-width: 900px) {
            .scan-vin-btn {
                -webkit-tap-highlight-color: rgba(0, 255, 136, 0.3);
            }
            
            /* Ensure dropdowns work well on mobile */
            select {
                padding: 10px !important;
            }
            
            /* Better touch targets for small screens */
            #entries-dropdown {
                min-height: 44px;
            }
        }
        
        /* Enhanced Visual Design for Android/Mobile Devices */
        @media (max-width: 900px) {
            /* Modern gradient background for mobile */
            body {
                background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            }
            
            /* Refined container with subtle elevation */
            .container {
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
                border-radius: 12px;
                overflow: hidden;
            }
            
            /* Polished form fields */
            .form-field input,
            .form-field textarea,
            .form-field [contenteditable] {
                border-radius: 6px;
                transition: all 0.2s ease;
            }
            
            .form-field input:focus,
            .form-field textarea:focus,
            .form-field [contenteditable]:focus {
                box-shadow: 0 0 0 3px rgba(0, 150, 255, 0.2);
                transform: scale(1.01);
            }
            
            /* Modern button styling */
            .btn-professional {
                background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
                border: none;
                box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
                transition: all 0.3s ease;
                font-weight: 600;
                letter-spacing: 0.5px;
            }
            
            .btn-professional:active {
                transform: translateY(2px);
                box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4);
            }
            
            /* Enhanced VIN scanner button */
            .scan-vin-btn {
                background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
                box-shadow: 0 4px 16px rgba(0, 255, 136, 0.4);
                transition: all 0.3s ease;
                animation: pulse-glow 2s infinite;
                width: 24px !important;
                height: 24px !important;
                font-size: 13px !important;
                right: -28px !important;
            }
            
            @keyframes pulse-glow {
                0%, 100% {
                    box-shadow: 0 4px 16px rgba(0, 255, 136, 0.4);
                }
                50% {
                    box-shadow: 0 4px 24px rgba(0, 255, 136, 0.6);
                }
            }
            
            .scan-vin-btn:active {
                transform: translateY(-50%) scale(0.95);
            }
            
            /* Refined scanner overlay */
            #scanner-overlay {
                background: rgba(0, 0, 0, 0.95);
                backdrop-filter: blur(10px);
            }
            
            #scanner-header {
                background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
            }
            
            #scanner-header h2 {
                font-weight: 600;
                letter-spacing: 0.5px;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }
            
            /* Modern scanner buttons */
            .scanner-close-btn {
                background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
                transition: all 0.2s ease;
            }
            
            .scanner-close-btn:active {
                transform: scale(0.95);
            }
            
            #text-scan-mode-btn {
                background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
                box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
                transition: all 0.2s ease;
            }
            
            #barcode-scan-mode-btn {
                background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
                box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
                transition: all 0.2s ease;
            }
            
            #manual-vin-btn {
                background: linear-gradient(135deg, #607d8b 0%, #455a64 100%);
                box-shadow: 0 2px 8px rgba(96, 125, 139, 0.3);
                transition: all 0.2s ease;
            }
            
            #text-scan-mode-btn:active,
            #barcode-scan-mode-btn:active,
            #manual-vin-btn:active {
                transform: scale(0.95);
            }
            
            /* Enhanced scan status */
            #scan-status {
                border-radius: 8px;
                padding: 12px 20px;
                font-size: 15px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            /* Refined dropdown */
            #entries-dropdown {
                border-radius: 10px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
                border: 1px solid #404040;
            }
            
            #entry-search {
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                border: 1px solid #404040;
                transition: all 0.2s ease;
            }
            
            #entry-search:focus {
                border-color: #2196f3;
                box-shadow: 0 2px 12px rgba(33, 150, 243, 0.3);
            }
            
            /* Modern bottom bar */
            #bottom-bar {
                background: linear-gradient(180deg, #1a1a1a 0%, #2d2d2d 100%);
                border-top: 2px solid #404040;
                box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(15px);
            }
            
            /* Enhanced status indicator */
            #firebase-status {
                backdrop-filter: blur(10px);
                font-weight: 600;
                letter-spacing: 0.5px;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            }
            
            /* Smooth animations for all interactive elements */
            button, input, select, textarea, [contenteditable] {
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            /* Refined scrollbar for mobile webkit browsers */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            
            ::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
                border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
            }
        }

        /* ===== CLEAN FORM STYLES ===== */
        
        .work-order {
            width: 850px;
            min-height: 1100px;
            background: white;
            border: 2px solid #000;
            margin: 0 auto;
            font-size: 11px;
        }

        /* Company Header */
        .company-header {
            text-align: center;
            padding: 6px;
            border-bottom: 2px solid #000;
            position: relative;
        }

        .company-header h1 {
            font-size: 20px;
            margin: 0 0 3px 0;
            font-weight: bold;
        }

        .company-header p {
            font-size: 10px;
            margin: 1px 0;
        }
        
        /* Editable company info hover effect */
        .company-header h1:hover,
        .company-header p:hover {
            background-color: #fffacd;
            outline: 1px dashed #999;
        }
        
        .company-header h1:focus,
        .company-header p:focus {
            background-color: #fff8dc;
            outline: 2px solid #4CAF50;
        }

        /* Header */
        .header {
            border-bottom: 2px solid #000;
        }

        .header-row {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            border-bottom: 1px solid #000;
        }

        .header-row:last-child {
            border-bottom: none;
        }

        .header-field {
            border-right: 1px solid #000;
            padding: 3px;
        }

        .header-field:last-child {
            border-right: none;
        }

        .header-field label {
            font-weight: bold;
            font-size: 9px;
            display: block;
            margin-bottom: 1px;
        }

        .header-field input {
            width: 100%;
            border: none;
            font-size: 11px;
            padding: 2px;
            color: #000;
            font-weight: 500;
        }

        /* Customer Section */
        .customer-section {
            border-bottom: 2px solid #000;
            padding: 5px;
        }

        .customer-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 3px;
        }

        .customer-field label {
            font-weight: bold;
            font-size: 9px;
            display: block;
        }

        .customer-field input {
            width: 100%;
            border: none;
            border-bottom: 1px solid #000;
            font-size: 11px;
            padding: 2px;
            color: #000;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            border-bottom: 2px solid #000;
        }

        /* Parts Table */
        .parts-header {
            display: grid;
            grid-template-columns: 50px 1fr 80px 80px;
            background: #f0f0f0;
            border-bottom: 1px solid #000;
            font-weight: bold;
            font-size: 10px;
        }

        .parts-header div {
            padding: 3px;
            border-right: 1px solid #000;
        }

        .parts-header div:last-child {
            border-right: none;
        }

        .part-row {
            display: grid;
            grid-template-columns: 50px 1fr 80px 80px;
            border-bottom: 1px solid #000;
            min-height: 18px;
        }

        .part-row div {
            border-right: 1px solid #000;
            padding: 3px;
        }

        .part-row div:last-child {
            border-right: none;
        }

        .part-row input {
            width: 100%;
            border: none;
            font-size: 11px;
            height: 100%;
            color: #000;
            font-weight: 500;
        }

        /* Description Section */
        .description-section {
            padding: 8px;
            border-left: 2px solid #000;
        }

        .description-section label {
            font-weight: bold;
            font-size: 10px;
            display: block;
            margin-bottom: 5px;
        }

        .description-section textarea {
            width: 100%;
            border: none;
            font-size: 11px;
            font-family: Arial, sans-serif;
            resize: none;
            height: 396px;
            text-align: center;
            color: #000;
            font-weight: 500;
        }

        /* Footer */
        .footer {
            padding: 6px;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 6px;
        }

        .footer-section h4 {
            font-size: 10px;
            margin-bottom: 3px;
            text-decoration: underline;
        }

        .footer-field {
            margin-bottom: 2px;
            font-size: 9px;
        }

        .footer-field label {
            display: inline-block;
            width: 20px;
            font-weight: bold;
        }

        .footer-field input[type="text"] {
            width: 40px;
            border: none;
            border-bottom: 1px solid #000;
            font-size: 9px;
            margin-left: 0px;
            color: #000;
            font-weight: 500;
        }

        .footer-field input[type="checkbox"] {
            margin-right: 5px;
        }

        /* Oil Change and State Inspection wider labels */
        .footer-section.oil-change .footer-field label,
        .footer-section.state-inspection .footer-field label,
        .footer-section.state-inspection div .footer-field label,
        .footer-section.tire-pressure .footer-field label {
            width: 50px;
        }

        .footer-section.oil-change .footer-field input[type="text"],
        .footer-section.state-inspection .footer-field input[type="text"],
        .footer-section.state-inspection div .footer-field input[type="text"] {
            width: 80px;
        }

        /* Controls */
        .controls {
            margin-bottom: 20px;
            text-align: center;
        }

        .btn {
            padding: 10px 20px;
            margin: 5px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            body * {
                visibility: hidden;
            }

            .work-order, .work-order * {
                visibility: visible;
            }

            .work-order {
                position: absolute;
                left: 0;
                top: 0;
                border: 2px solid #000;
            }

            .container {
                max-width: 100%;
                padding: 0;
                box-shadow: none;
            }
        }

        .no-print {
            display: block;
        }

        @media print {
            .no-print,
            #labor-timer-widget {
                display: none !important;
            }
        }
        
        /* Labor Timer Widget */
        #labor-timer-widget {
            position: fixed;
            top: 80px;
            left: 20px;
            width: 280px;
            background: #1e1e1e;
            border: 2px solid #00bfff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 191, 255, 0.3);
            z-index: 9999;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            cursor: move;
        }
        
        #labor-timer-widget.minimized {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
        }
        
        #labor-timer-widget.minimized .widget-content {
            display: none;
        }
        
        #labor-timer-widget.minimized .widget-header {
            height: 60px;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
        }
        
        #labor-timer-widget.minimized .widget-header h3 {
            display: none;
        }
        
        #labor-timer-widget.minimized .minimize-btn {
            font-size: 24px;
            margin: 0;
        }
        
        .widget-header {
            background: linear-gradient(135deg, #00bfff 0%, #0088cc 100%);
            padding: 10px 15px;
            border-radius: 6px 6px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .widget-header h3 {
            margin: 0;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }
        
        .minimize-btn {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .minimize-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .widget-content {
            padding: 15px;
        }
        
        .labor-hours-display {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .labor-hours-display label {
            display: block;
            color: #00bfff;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }
        
        .labor-hours-value {
            color: #00ff88;
            font-size: 20px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }
        
        .labor-hours-subtitle {
            color: #888;
            font-size: 10px;
            margin-top: 4px;
        }
        
        .tech-notes-section label {
            display: block;
            color: #00bfff;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }
        
        #tech_notes_widget {
            width: 100%;
            height: 120px;
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 10px;
            color: #fff;
            font-size: 13px;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            resize: vertical;
            outline: none;
        }
        
        #tech_notes_widget:focus {
            border-color: #00bfff;
            box-shadow: 0 0 0 2px rgba(0, 191, 255, 0.2);
        }
        
        .widget-save-status {
            color: #00ff88;
            font-size: 10px;
            margin-top: 6px;
            text-align: right;
            min-height: 14px;
        }

        /* Login Screen Styles */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }

        .login-container h2 {
            margin: 0 0 10px 0;
            color: #333;
            text-align: center;
        }

        .login-container p {
            margin: 0 0 30px 0;
            color: #666;
            text-align: center;
            font-size: 14px;
        }

        .login-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-form button {
            width: 100%;
            padding: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-form button:hover {
            background: #5568d3;
        }

        .login-error {
            color: #dc3545;
            font-size: 13px;
            margin-bottom: 10px;
            text-align: center;
            display: none;
        }

        /* Device Name Modal */
        #device-name-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
        }

        .device-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
        }

        .device-modal-content h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .device-modal-content p {
            margin: 0 0 20px 0;
            color: #666;
            font-size: 14px;
        }

        .device-modal-content input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .device-modal-content input:focus {
            outline: none;
            border-color: #667eea;
        }

        .device-modal-content button {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .device-modal-content button:hover {
            background: #218838;
        }

        .device-examples {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-container">
            <h2>ðŸ”§ Work Order Guru</h2>
            <p>Company Login</p>
            <div class="login-error" id="login-error"></div>
            <form class="login-form" id="login-form">
                <input type="email" id="company-email" placeholder="Company Email" required autocomplete="username">
                <input type="password" id="company-password" placeholder="Password" required autocomplete="current-password">
                <button type="submit">Login</button>
            </form>
        </div>
    </div>

    <!-- Device Name Modal -->
    <div id="device-name-modal">
        <div class="device-modal-content">
            <h3>ðŸ‘‹ Welcome!</h3>
            <p>Please enter a name for this device so your team knows who's working on each order.</p>
            <input type="text" id="device-name-input" placeholder="e.g., Front Desk PC, Tech 1 Tablet, Manager Laptop" required>
            <div class="device-examples">Examples: Front Desk, Bay 1, Manager Office, Mobile Tablet</div>
            <button onclick="saveDeviceName()">Continue</button>
        </div>
    </div>

    <div id="firebase-status" class="no-print">Connecting...</div>
    <div class="container">
        <!-- Work Order -->
        <div class="work-order" id="repair-order-form">
            <!-- Company Header -->
            <div class="company-header">
                <h1 id="company_name" contenteditable="true" style="cursor: text; outline: none;" title="Click to edit company name">Edward Colosimo Auto Sales and Service</h1>
                <p id="company_address" contenteditable="true" style="cursor: text; outline: none;" title="Click to edit address">1682 Evans City Road, Evans City, PA 16033</p>
                <p id="company_contact" contenteditable="true" style="cursor: text; outline: none;" title="Click to edit contact info">Phone: (724) 538-5331 | Email: info@yourcompany.com</p>
                <p id="company_website" contenteditable="true" style="cursor: text; outline: none;" title="Click to edit website">Website: www.ecautomotive.com</p>
                <small id="company-hint" style="color: #666; font-size: 8px; display: none; margin-top: 5px;">ðŸ’¡ Click company info above to edit â€¢ Then click "Save Company Info" button</small>
            </div>

            <!-- Header -->
            <div class="header">
                <div class="header-row">
                    <div class="header-field">
                        <label>DATE:</label>
                        <input type="text" id="date">
                    </div>
                    <div class="header-field">
                        <label>R.O. #:</label>
                        <input type="text" id="ro_number">
                    </div>
                    <div class="header-field">
                        <label>STOCK #:</label>
                        <input type="text" id="stock_number">
                    </div>
                    <div class="header-field">
                        <label>PLATE:</label>
                        <input type="text" id="plate">
                    </div>
                    <div class="header-field">
                        <label>ODOMETER:</label>
                        <input type="text" id="odometer">
                    </div>
                    <div class="header-field">
                        <label>TECH:</label>
                        <input type="text" id="tech">
                    </div>
                </div>
            </div>

            <!-- Customer Section -->
            <div class="customer-section">
                <div class="customer-row">
                    <div class="customer-field" style="grid-column: span 4;">
                        <label>NAME:</label>
                        <input type="text" id="customer_name">
                    </div>
                </div>
                <div class="customer-row" style="grid-template-columns: 2fr 1fr;">
                    <div class="customer-field">
                        <label>ADDRESS:</label>
                        <input type="text" id="customer_address">
                    </div>
                    <div class="customer-field">
                        <label>PHONE:</label>
                        <input type="text" id="customer_phone">
                    </div>
                </div>
                <div class="customer-row" style="grid-template-columns: 2fr 120px 1fr;">
                    <div class="customer-field">
                        <label>VIN NUMBER:</label>
                        <input type="text" id="vin_number">
                    </div>
                    <div class="customer-field">
                        <label>MFG DATE:</label>
                        <input type="text" id="mfg_date">
                    </div>
                    <div class="customer-field">
                        <label>COUNTY:</label>
                        <input type="text" id="county">
                    </div>
                </div>
                <div class="customer-row" style="grid-template-columns: 80px 1fr 1fr 1fr 100px;">
                    <div class="customer-field">
                        <label>YEAR:</label>
                        <input type="text" id="year">
                    </div>
                    <div class="customer-field">
                        <label>MAKE:</label>
                        <input type="text" id="make">
                    </div>
                    <div class="customer-field">
                        <label>MODEL:</label>
                        <input type="text" id="model">
                    </div>
                    <div class="customer-field">
                        <label>TRIM:</label>
                        <input type="text" id="trim">
                    </div>
                    <div class="customer-field">
                        <label>ENGINE:</label>
                        <input type="text" id="engine_size">
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Parts Section -->
                <div class="parts-section">
                    <div class="parts-header">
                        <div>QTY</div>
                        <div>PART #</div>
                        <div>PRICE</div>
                        <div>LABOR HRS</div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty1"></div>
                        <div><input type="text" id="part1"></div>
                        <div><input type="text" id="price1"></div>
                        <div><input type="text" id="labor1"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty2"></div>
                        <div><input type="text" id="part2"></div>
                        <div><input type="text" id="price2"></div>
                        <div><input type="text" id="labor2"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty3"></div>
                        <div><input type="text" id="part3"></div>
                        <div><input type="text" id="price3"></div>
                        <div><input type="text" id="labor3"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty4"></div>
                        <div><input type="text" id="part4"></div>
                        <div><input type="text" id="price4"></div>
                        <div><input type="text" id="labor4"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty5"></div>
                        <div><input type="text" id="part5"></div>
                        <div><input type="text" id="price5"></div>
                        <div><input type="text" id="labor5"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty6"></div>
                        <div><input type="text" id="part6"></div>
                        <div><input type="text" id="price6"></div>
                        <div><input type="text" id="labor6"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty7"></div>
                        <div><input type="text" id="part7"></div>
                        <div><input type="text" id="price7"></div>
                        <div><input type="text" id="labor7"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty8"></div>
                        <div><input type="text" id="part8"></div>
                        <div><input type="text" id="price8"></div>
                        <div><input type="text" id="labor8"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty9"></div>
                        <div><input type="text" id="part9"></div>
                        <div><input type="text" id="price9"></div>
                        <div><input type="text" id="labor9"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty10"></div>
                        <div><input type="text" id="part10"></div>
                        <div><input type="text" id="price10"></div>
                        <div><input type="text" id="labor10"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty11"></div>
                        <div><input type="text" id="part11"></div>
                        <div><input type="text" id="price11"></div>
                        <div><input type="text" id="labor11"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty12"></div>
                        <div><input type="text" id="part12"></div>
                        <div><input type="text" id="price12"></div>
                        <div><input type="text" id="labor12"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty13"></div>
                        <div><input type="text" id="part13"></div>
                        <div><input type="text" id="price13"></div>
                        <div><input type="text" id="labor13"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty14"></div>
                        <div><input type="text" id="part14"></div>
                        <div><input type="text" id="price14"></div>
                        <div><input type="text" id="labor14"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty15"></div>
                        <div><input type="text" id="part15"></div>
                        <div><input type="text" id="price15"></div>
                        <div><input type="text" id="labor15"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty16"></div>
                        <div><input type="text" id="part16"></div>
                        <div><input type="text" id="price16"></div>
                        <div><input type="text" id="labor16"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty17"></div>
                        <div><input type="text" id="part17"></div>
                        <div><input type="text" id="price17"></div>
                        <div><input type="text" id="labor17"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty18"></div>
                        <div><input type="text" id="part18"></div>
                        <div><input type="text" id="price18"></div>
                        <div><input type="text" id="labor18"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty19"></div>
                        <div><input type="text" id="part19"></div>
                        <div><input type="text" id="price19"></div>
                        <div><input type="text" id="labor19"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty20"></div>
                        <div><input type="text" id="part20"></div>
                        <div><input type="text" id="price20"></div>
                        <div><input type="text" id="labor20"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty21"></div>
                        <div><input type="text" id="part21"></div>
                        <div><input type="text" id="price21"></div>
                        <div><input type="text" id="labor21"></div>
                    </div>
                    <div class="part-row">
                        <div><input type="text" id="qty22"></div>
                        <div><input type="text" id="part22"></div>
                        <div><input type="text" id="price22"></div>
                        <div><input type="text" id="labor22"></div>
                    </div>
                </div>

                <!-- Description Section -->
                <div class="description-section">
                    <label>DESCRIPTION OF WORK:</label>
                    <textarea id="description"></textarea>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <div class="footer-grid">
                    <!-- Emissions -->
                    <div class="footer-section">
                        <h4>EMISSIONS:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                            <div class="footer-field">
                                <input type="checkbox" id="em_cat">
                                <label>CAT</label>
                            </div>
                            <div class="footer-field">
                                <input type="checkbox" id="em_egr">
                                <label>EGR</label>
                            </div>
                            <div class="footer-field">
                                <input type="checkbox" id="em_pcv">
                                <label>PCV</label>
                            </div>
                            <div class="footer-field">
                                <input type="checkbox" id="em_fuel_rest">
                                <label>FUEL</label>
                            </div>
                            <div class="footer-field">
                                <input type="checkbox" id="em_air">
                                <label>AIR</label>
                            </div>
                            <div class="footer-field">
                                <input type="checkbox" id="em_evap">
                                <label>EVAP</label>
                            </div>
                        </div>
                    </div>

                    <!-- Tires -->
                    <div class="footer-section">
                        <h4>TIRES:</h4>
                        <div class="footer-field">
                            <label>LF:</label>
                            <input type="text" id="tire_lf">
                        </div>
                        <div class="footer-field">
                            <label>RF:</label>
                            <input type="text" id="tire_rf">
                        </div>
                        <div class="footer-field">
                            <label>LR:</label>
                            <input type="text" id="tire_lr">
                        </div>
                        <div class="footer-field">
                            <label>RR:</label>
                            <input type="text" id="tire_rr">
                        </div>
                    </div>

                    <!-- Tire Pressure -->
                    <div class="footer-section tire-pressure">
                        <h4>TIRE PRESSURE (PSI):</h4>
                        <div class="footer-field">
                            <label>FRONT:</label>
                            <input type="text" id="pressure_front">
                        </div>
                        <div class="footer-field">
                            <label>REAR:</label>
                            <input type="text" id="pressure_rear">
                        </div>
                    </div>

                    <!-- Brakes -->
                    <div class="footer-section">
                        <h4>BRAKES /32:</h4>
                        <div class="footer-field">
                            <label>LF:</label>
                            <input type="text" id="brake_lf">
                        </div>
                        <div class="footer-field">
                            <label>RF:</label>
                            <input type="text" id="brake_rf">
                        </div>
                        <div class="footer-field">
                            <label>LR:</label>
                            <input type="text" id="brake_lr">
                        </div>
                        <div class="footer-field">
                            <label>RR:</label>
                            <input type="text" id="brake_rr">
                        </div>
                    </div>
                </div>

                <div class="footer-grid" style="margin-top: 10px;">
                    <!-- Oil Change -->
                    <div class="footer-section oil-change">
                        <h4>OIL CHANGE:</h4>
                        <div class="footer-field">
                            <label>LAST CHANGE:</label>
                            <input type="text" id="oil_last_change">
                        </div>
                        <div class="footer-field">
                            <label>NEXT CHANGE:</label>
                            <input type="text" id="oil_next_change">
                        </div>
                    </div>

                    <!-- State Inspection -->
                    <div class="footer-section state-inspection" style="grid-column: span 2;">
                        <h4 style="margin: 0;">STATE INSPECTION:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px;">
                            <div>
                                <div class="footer-field">
                                    <label>EXPIRES:</label>
                                    <input type="text" id="si_expires">
                                </div>
                                <div class="footer-field">
                                    <label>MILEAGE:</label>
                                    <input type="text" id="si_mileage">
                                </div>
                            </div>
                            <div>
                                <div class="footer-field">
                                    <label>OLD EXP:</label>
                                    <input type="text" id="old_si_exp">
                                </div>
                                <div class="footer-field">
                                    <label>OLD MILES:</label>
                                    <input type="text" id="old_si_miles">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Pricing Section -->
                <div style="margin-top: 10px; padding: 10px; border: 2px solid black; background-color: #f9f9f9;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label style="font-weight: bold; font-size: 10px; display: block; margin-bottom: 3px;">PARTS SUBTOTAL:</label>
                            <input type="text" id="parts_subtotal" style="width: 100%; padding: 4px; border: 1px solid black; font-size: 11px;">
                        </div>
                        <div>
                            <label style="font-weight: bold; font-size: 10px; display: block; margin-bottom: 3px;">LABOR:</label>
                            <input type="text" id="labor_cost" style="width: 100%; padding: 4px; border: 1px solid black; font-size: 11px;">
                        </div>
                        <div>
                            <label style="font-weight: bold; font-size: 10px; display: block; margin-bottom: 3px;">SHOP FEES:</label>
                            <input type="text" id="shop_fees" style="width: 100%; padding: 4px; border: 1px solid black; font-size: 11px;">
                        </div>
                        <div>
                            <label style="font-weight: bold; font-size: 10px; display: block; margin-bottom: 3px;">TAX:</label>
                            <input type="text" id="tax_amount" style="width: 100%; padding: 4px; border: 1px solid black; font-size: 11px;">
                        </div>
                    </div>
                    <div style="text-align: right; border-top: 2px solid black; padding-top: 10px;">
                        <label style="font-weight: bold; font-size: 12px; margin-right: 10px;">GRAND TOTAL:</label>
                        <input type="text" id="grand_total" style="width: 150px; padding: 6px; border: 2px solid black; font-weight: bold; font-size: 14px; text-align: right; background-color: white;">
                    </div>
                </div>

                <!-- Technician Signature Section -->
                <div style="margin-top: 10px; padding: 8px; border: 1px solid black;">
                    <!-- START SIGNATURE SECTION - Easy to modify/remove -->
                    <div style="display: grid; grid-template-columns: 1fr 0.5fr 1fr 0.5fr; gap: 15px;">
                        <div>
                            <label style="font-weight: bold; font-size: 10px; display: block; margin-bottom: 3px;">TECHNICIAN SIGNATURE:</label>
                            <div style="border-bottom: 1px solid black; height: 20px;"></div>
                        </div>
                        <div>
                            <label style="font-weight: bold; font-size: 10px; display: block; margin-bottom: 3px;">DATE:</label>
                            <div style="border-bottom: 1px solid black; height: 20px;"></div>
                        </div>
                        <div>
                            <label style="font-weight: bold; font-size: 10px; display: block; margin-bottom: 3px;">CUSTOMER SIGNATURE:</label>
                            <div style="border-bottom: 1px solid black; height: 20px;"></div>
                        </div>
                        <div>
                            <label style="font-weight: bold; font-size: 10px; display: block; margin-bottom: 3px;">DATE:</label>
                            <div style="border-bottom: 1px solid black; height: 20px;"></div>
                        </div>
                    </div>
                    <!-- Disclaimer Text -->
                    <div style="margin-top: 8px; text-align: center;">
                        <p style="font-size: 9px; font-style: italic; color: #555; margin: 0; line-height: 1.3;">
                            By signing above, customer authorizes the above repairs and services, acknowledges receipt of work performed,
                            and accepts full financial responsibility for all charges. Shop is not responsible for items left over 30 days after work is completed.
                        </p>
                    </div>
                    <!-- END SIGNATURE SECTION -->
                </div>
            </div>
        </div>
    </div>

    <!-- Labor Timer Widget -->
    <div id="labor-timer-widget">
        <div class="widget-header">
            <h3>â± Labor & Notes</h3>
            <button class="minimize-btn" onclick="toggleWidget()">âˆ’</button>
        </div>
        <div class="widget-content">
            <div class="labor-hours-display">
                <label>â± Labor Hours</label>
                <div class="labor-hours-value" id="labor_hours_display">0.0 hrs</div>
                <div class="labor-hours-subtitle">(from mobile timer)</div>
            </div>
            <div class="tech-notes-section">
                <label>ðŸ“ Tech Notes</label>
                <textarea id="tech_notes_widget" placeholder="Enter technician notes..."></textarea>
                <div class="widget-save-status" id="widget_save_status"></div>
            </div>
        </div>
    </div>

    <!-- VIN Hover Overlay -->
    <div id="vin-overlay" class="vin-overlay"></div>

    <!-- VIN Scanner Camera Overlay -->
    <div id="scanner-overlay">
        <div class="scanner-header">
            <div class="scanner-title">Scan VIN Barcode</div>
            <button class="scanner-close-btn" id="scanner-close-btn">âœ•</button>
        </div>
        <div id="scanner-container">
            <div id="scanner-video"></div>
            <div style="position: absolute; top: 45%; left: 10%; right: 10%; height: 10%; border: 2px solid #00ff88; border-radius: 8px; box-shadow: 0 0 20px rgba(0, 255, 136, 0.5); pointer-events: none;"></div>
            <div id="scan-status" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 255, 136, 0.2); color: #00ff88; padding: 8px 16px; border-radius: 20px; font-weight: bold; display: none;">Reading...</div>
        </div>
        <div class="scanner-instructions">
            <p style="font-size: 18px; font-weight: bold; margin: 5px 0;">Point at VIN barcode or stamped text</p>
            <p style="font-size: 14px; margin: 5px 0; opacity: 0.8;">Align within green box â€¢ Hold steady â€¢ Good lighting helps</p>
            <div style="margin-top: 10px;">
                <button id="text-scan-mode-btn" style="display: none; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; margin-right: 10px;">ðŸ“ Text Mode</button>
                <button id="barcode-scan-mode-btn" style="display: none; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; margin-right: 10px;">ðŸ“· Barcode Mode</button>
                <button id="manual-vin-btn" style="padding: 10px 20px; background: #555; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;">âŒ¨ï¸ Type Manually</button>
            </div>
        </div>
    </div>
    
    <div id="bottom-bar" class="no-print">
  <div style="max-width:850px;margin:0 auto 10px auto;text-align:left;">
    <input id="entry-search" type="text" placeholder="Search by customer, VIN, vehicle, or date..." style="width:45%;padding:4px 8px;margin-bottom:4px;border-radius:4px;border:1px solid #404040;font-size:13px;text-transform:uppercase;background:#2d2d2d;color:#ffffff;">
    <select id="entries-dropdown" style="width:75%;padding:4px 8px;border-radius:4px;border:1px solid #404040;font-size:13px;text-transform:uppercase;background:#2d2d2d;color:#ffffff;">
      <option value="">Select a saved entry...</option>
    </select>
    <button id="delete-entry-btn" class="btn-professional" style="display:none;">Delete</button>
  </div>
  <button id="save-btn" class="btn-professional">Save</button>
  <button id="new-work-order-btn" class="btn-professional">New Work Order</button>
  <button id="new-order-btn" class="btn-professional" style="display:none;">New Order (Same Customer)</button>
  <button id="print-btn" class="btn-professional">Print</button>
  <button id="save-company-btn" class="btn-professional" style="display:none;" title="Save current company info as default for all new work orders">ðŸ’¾ Save Company Info</button>
  <span id="save-status" style="margin-left:16px;font-size:14px;color:#00ff88;"></span>
  <button id="force-unlock-btn" title="Force unlock this work order">âš ï¸ Force Unlock</button>
</div>

    <script>
        // ===== VIN SCANNER WITH CAMERA =====
        let scannerActive = false;
        
        // Initialize VIN scanner button
        document.addEventListener('DOMContentLoaded', function() {
            // Real-time part number field resizing
            function resizePartNumberField(pnDiv) {
                const text = pnDiv.textContent || '';
                if (!text) return;
                
                const textLength = text.length;
                let fontSize;
                if (textLength > 25) {
                    fontSize = '9px';
                } else if (textLength > 20) {
                    fontSize = '10px';
                } else if (textLength > 15) {
                    fontSize = '11px';
                } else if (textLength > 12) {
                    fontSize = '12px';
                } else {
                    fontSize = '13px';
                }
                pnDiv.style.fontSize = fontSize;
            }
            
            // Add event listeners to all part number fields
            for (let i = 1; i <= 22; i++) {
                const pnDiv = document.getElementById('part' + i);
                if (pnDiv) {
                    // Resize on input
                    pnDiv.addEventListener('input', function() {
                        resizePartNumberField(this);
                    });
                    // Resize on load if there's existing content
                    resizePartNumberField(pnDiv);
                }
            }
            
            const scanBtn = document.getElementById('scan-vin-btn');
            const closeBtn = document.getElementById('scanner-close-btn');
            const overlay = document.getElementById('scanner-overlay');
            
            if (scanBtn) {
                scanBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    startScanner();
                });
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    stopScanner();
                });
            }
            
            // Close on overlay click (outside scanner container)
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        stopScanner();
                    }
                });
            }
            
            // Manual VIN entry button (loaded after scanner opens)
            setTimeout(function() {
                const manualBtn = document.getElementById('manual-vin-btn');
                if (manualBtn) {
                    manualBtn.addEventListener('click', function() {
                        stopScanner();
                        const vinEditable = document.getElementById('vin_number');
                        if (vinEditable) {
                            vinEditable.focus();
                        }
                    });
                }
                
                // Text mode toggle button
                const textModeBtn = document.getElementById('text-scan-mode-btn');
                if (textModeBtn) {
                    textModeBtn.addEventListener('click', function() {
                        switchScanMode('text');
                    });
                }
                
                // Barcode mode toggle button
                const barcodeModeBtn = document.getElementById('barcode-scan-mode-btn');
                if (barcodeModeBtn) {
                    barcodeModeBtn.addEventListener('click', function() {
                        switchScanMode('barcode');
                    });
                }
            }, 1000);
        });
        
        let videoStream = null;
        let scanningInterval = null;
        let scanMode = 'barcode'; // 'barcode' or 'text'
        let textDetectorSupported = false;
        
        // Preserve text selection ONLY when Ctrl key is held (Firefox/Edge fix)
        // This prevents interference with normal app functions
        let savedSelectionRange = null;
        let ctrlKeyHeld = false;
        
        // Track Ctrl key state
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                ctrlKeyHeld = true;
            }
        });
        
        document.addEventListener('keyup', function(e) {
            if (!e.ctrlKey && !e.metaKey) {
                ctrlKeyHeld = false;
            }
        });
        
        // Only save selection when Ctrl is held (user intends to copy)
        document.addEventListener('selectionchange', function() {
            if (ctrlKeyHeld) {
                const selection = window.getSelection();
                const selectedText = selection.toString();
                
                if (selectedText.length > 0) {
                    try {
                        const target = document.activeElement;
                        if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') {
                            // Save input field selection
                            savedSelectionRange = {
                                element: target,
                                start: target.selectionStart,
                                end: target.selectionEnd
                            };
                        }
                    } catch (e) {
                        // Ignore errors
                    }
                }
            }
        });
        
        // Restore selection if it gets cleared while Ctrl is held
        document.addEventListener('mouseup', function(e) {
            if (ctrlKeyHeld && savedSelectionRange) {
                const target = e.target;
                if (target === savedSelectionRange.element) {
                    setTimeout(() => {
                        try {
                            target.setSelectionRange(savedSelectionRange.start, savedSelectionRange.end);
                        } catch (e) {
                            // Ignore
                        }
                    }, 0);
                }
            } else {
                // Normal operation - clear saved selection
                savedSelectionRange = null;
            }
        });
        
        async function startScanner() {
            const overlay = document.getElementById('scanner-overlay');
            overlay.classList.add('active');
            scannerActive = true;
            scanMode = 'barcode'; // Start with barcode mode
            
            // Check if text detection is supported
            textDetectorSupported = 'TextDetector' in window;
            
            // Show appropriate mode buttons
            const textModeBtn = document.getElementById('text-scan-mode-btn');
            const barcodeModeBtn = document.getElementById('barcode-scan-mode-btn');
            
            if (textDetectorSupported) {
                // Device supports text detection - show toggle buttons
                if (textModeBtn) textModeBtn.style.display = 'inline-block';
                if (barcodeModeBtn) barcodeModeBtn.style.display = 'none'; // Hide barcode button initially
                console.log('Text detection supported - showing mode toggle');
            } else {
                // Hide both buttons - barcode only mode
                if (textModeBtn) textModeBtn.style.display = 'none';
                if (barcodeModeBtn) barcodeModeBtn.style.display = 'none';
                console.log('Text detection not supported - barcode only');
            }
            
            const videoContainer = document.getElementById('scanner-video');
            videoContainer.innerHTML = ''; // Clear previous content
            
            // Create video element
            const video = document.createElement('video');
            video.setAttribute('playsinline', '');
            video.setAttribute('autoplay', '');
            video.style.width = '100%';
            video.style.height = '100%';
            video.style.objectFit = 'cover';
            videoContainer.appendChild(video);
            
            try {
                // Detect device type for optimal camera settings
                const isAndroid = /Android/i.test(navigator.userAgent);
                const isMobile = /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent);
                
                // Optimize camera constraints based on device
                let cameraConstraints = {
                    video: {
                        facingMode: 'environment'
                    }
                };
                
                if (isAndroid) {
                    // Android-optimized settings for better performance
                    cameraConstraints.video = {
                        facingMode: 'environment',
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30, max: 30 }
                    };
                    console.log('Using Android-optimized camera settings');
                } else if (isMobile) {
                    // Other mobile devices
                    cameraConstraints.video = {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    };
                } else {
                    // Desktop - use higher resolution
                    cameraConstraints.video = {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    };
                }
                
                // Request camera access
                videoStream = await navigator.mediaDevices.getUserMedia(cameraConstraints);
                
                video.srcObject = videoStream;
                await video.play();
                
                console.log('Camera started successfully');
                
                // Check if native BarcodeDetector is available (Chrome Android)
                if ('BarcodeDetector' in window) {
                    console.log('Using native BarcodeDetector - this should work great!');
                    const scanStatus = document.getElementById('scan-status');
                    if (scanStatus) {
                        scanStatus.style.display = 'block';
                        scanStatus.textContent = 'Camera ready - point at VIN barcode';
                    }
                    startNativeBarcodeScanning(video);
                } else {
                    console.log('BarcodeDetector not available, using Quagga fallback');
                    const scanStatus = document.getElementById('scan-status');
                    if (scanStatus) {
                        scanStatus.style.display = 'block';
                        scanStatus.textContent = 'Loading scanner...';
                    }
                    startQuaggaScanning(video);
                }
                
            } catch (err) {
                console.error('Camera error:', err);
                alert('Unable to access camera. Please ensure camera permissions are granted.\n\nError: ' + err.message);
                stopScanner();
            }
        }
        
        async function startNativeBarcodeScanning(video) {
            const barcodeDetector = new BarcodeDetector({ formats: ['code_39', 'code_128', 'ean_13', 'ean_8', 'itf'] });
            const scanStatus = document.getElementById('scan-status');
            let detectionCount = {};
            
            if (scanStatus) {
                scanStatus.style.display = 'block';
                scanStatus.textContent = 'Ready to scan...';
            }
            
            scanningInterval = setInterval(async () => {
                if (!scannerActive) return;
                
                try {
                    const barcodes = await barcodeDetector.detect(video);
                    
                    if (barcodes.length > 0) {
                        for (const barcode of barcodes) {
                            const code = barcode.rawValue.toUpperCase().trim();
                            console.log('Detected barcode:', code, 'Length:', code.length, 'Format:', barcode.format);
                            
                            if (scanStatus) {
                                scanStatus.style.display = 'block';
                                scanStatus.textContent = 'Reading: ' + code.substring(0, 15) + '...';
                                scanStatus.style.background = 'rgba(255, 193, 7, 0.3)';
                                scanStatus.style.color = '#ffc107';
                            }
                            
                            // Clean the barcode - VINs should only contain valid characters
                            let cleanCode = code.replace(/[^A-HJ-NPR-Z0-9]/g, '');
                            
                            console.log('Cleaned barcode:', cleanCode, 'Length:', cleanCode.length);
                            
                            // If exactly 18 chars and starts with a digit, it might be a check digit - try removing it
                            if (cleanCode.length === 18) {
                                // Try removing first character
                                const withoutFirst = cleanCode.substring(1);
                                console.log('18 chars detected - trying without first char:', withoutFirst);
                                
                                if (/^[A-HJ-NPR-Z0-9]{17}$/.test(withoutFirst)) {
                                    cleanCode = withoutFirst;
                                    console.log('Using VIN without first character:', cleanCode);
                                }
                            }
                            
                            // Look for exactly 17 valid VIN characters
                            if (cleanCode.length === 17 && /^[A-HJ-NPR-Z0-9]{17}$/.test(cleanCode)) {
                                console.log('VIN confirmed (exact 17 chars):', cleanCode);
                                
                                if (scanStatus) {
                                    scanStatus.textContent = 'âœ“ VIN Found!';
                                    scanStatus.style.background = 'rgba(0, 255, 136, 0.3)';
                                    scanStatus.style.color = '#00ff88';
                                }
                                
                                processScannedVIN(cleanCode);
                                return;
                            }
                            
                            // If longer than 17, try to extract the 17-character VIN
                            // Some barcodes have check digits or prefixes
                            if (cleanCode.length > 17 && cleanCode.length <= 25) {
                                // Try to find a valid 17-character VIN sequence
                                // Check from position 0, 1, 2, etc.
                                for (let i = 0; i <= cleanCode.length - 17; i++) {
                                    const possibleVin = cleanCode.substring(i, i + 17);
                                    
                                    if (/^[A-HJ-NPR-Z0-9]{17}$/.test(possibleVin)) {
                                        console.log('Possible VIN found at position', i, ':', possibleVin, 'from barcode:', cleanCode);
                                        
                                        // Count detections of this specific VIN
                                        detectionCount[possibleVin] = (detectionCount[possibleVin] || 0) + 1;
                                        
                                        // Require 2 detections for VINs extracted from longer barcodes
                                        if (detectionCount[possibleVin] >= 2) {
                                            console.log('VIN confirmed (2 detections):', possibleVin);
                                            
                                            if (scanStatus) {
                                                scanStatus.textContent = 'âœ“ VIN Found!';
                                                scanStatus.style.background = 'rgba(0, 255, 136, 0.3)';
                                                scanStatus.style.color = '#00ff88';
                                            }
                                            
                                            processScannedVIN(possibleVin);
                                            return;
                                        }
                                        
                                        // Found a candidate, don't check other positions
                                        break;
                                    }
                                }
                            }
                            
                            // For shorter codes (14-16 chars), require 3 detections
                            if (cleanCode.length >= 14 && cleanCode.length < 17 && /^[A-HJ-NPR-Z0-9]+$/.test(cleanCode)) {
                                detectionCount[cleanCode] = (detectionCount[cleanCode] || 0) + 1;
                                
                                if (detectionCount[cleanCode] >= 3) {
                                    console.log('Partial VIN confirmed (3 detections):', cleanCode);
                                    
                                    if (scanStatus) {
                                        scanStatus.textContent = 'âœ“ VIN Found!';
                                        scanStatus.style.background = 'rgba(0, 255, 136, 0.3)';
                                        scanStatus.style.color = '#00ff88';
                                    }
                                    
                                    processScannedVIN(cleanCode);
                                    return;
                                }
                            }
                        }
                    } else {
                        // Clear old detection counts if no barcodes found
                        if (Object.keys(detectionCount).length > 5) {
                            detectionCount = {};
                        }
                    }
                } catch (err) {
                    console.error('Barcode detection error:', err);
                    if (scanStatus) {
                        scanStatus.textContent = 'Scanning... Point at barcode';
                    }
                }
            }, 100); // Scan every 100ms (10 times per second)
        }
        
        async function startTextDetection(video) {
            if (!textDetectorSupported) {
                console.log('Text detection not supported');
                return;
            }
            
            const textDetector = new TextDetector();
            const scanStatus = document.getElementById('scan-status');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            if (scanStatus) {
                scanStatus.style.display = 'block';
                scanStatus.textContent = 'Text mode - Point at stamped VIN...';
                scanStatus.style.background = 'rgba(33, 150, 243, 0.3)';
                scanStatus.style.color = '#2196f3';
            }
            
            scanningInterval = setInterval(async () => {
                if (!scannerActive) return;
                
                try {
                    // Set canvas size to match video
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // Draw current video frame to canvas
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Detect text in the frame
                    const texts = await textDetector.detect(canvas);
                    
                    if (texts.length > 0) {
                        // Look for VIN pattern in detected text
                        for (const textBlock of texts) {
                            const text = textBlock.rawValue.toUpperCase().replace(/[^A-Z0-9]/g, '');
                            console.log('Detected text:', text);
                            
                            if (scanStatus) {
                                scanStatus.style.display = 'block';
                                scanStatus.textContent = 'Reading text: ' + text.substring(0, 12) + '...';
                                scanStatus.style.background = 'rgba(33, 150, 243, 0.3)';
                                scanStatus.style.color = '#2196f3';
                            }
                            
                            // Look for 17-character VIN pattern
                            const vinMatch = text.match(/[A-HJ-NPR-Z0-9]{17}/);
                            if (vinMatch) {
                                const vin = vinMatch[0];
                                console.log('VIN found in text:', vin);
                                
                                if (scanStatus) {
                                    scanStatus.textContent = 'âœ“ VIN Found!';
                                    scanStatus.style.background = 'rgba(0, 255, 136, 0.3)';
                                    scanStatus.style.color = '#00ff88';
                                }
                                
                                processScannedVIN(vin);
                                return;
                            }
                            
                            // Also check if entire text is close to VIN length
                            if (text.length >= 15 && text.length <= 19 && /^[A-HJ-NPR-Z0-9]+$/.test(text)) {
                                const vin = text.substring(0, 17);
                                console.log('Possible VIN from text:', vin);
                                
                                if (scanStatus) {
                                    scanStatus.textContent = 'âœ“ VIN Found!';
                                    scanStatus.style.background = 'rgba(0, 255, 136, 0.3)';
                                    scanStatus.style.color = '#00ff88';
                                }
                                
                                processScannedVIN(vin);
                                return;
                            }
                        }
                    }
                } catch (err) {
                    console.error('Text detection error:', err);
                    if (scanStatus) {
                        scanStatus.textContent = 'Scanning text... Point at VIN';
                    }
                }
            }, 200); // Scan every 200ms (text detection is more intensive)
        }
        
        function startQuaggaScanning(video) {
            // Fallback to Quagga if BarcodeDetector not available
            if (typeof Quagga === 'undefined') {
                alert('Barcode scanning not available. Please try:\n1. Using Chrome browser\n2. Updating your browser\n3. Using a barcode scanner app instead');
                stopScanner();
                return;
            }
            
            const scanStatus = document.getElementById('scan-status');
            if (scanStatus) {
                scanStatus.style.display = 'block';
                scanStatus.textContent = 'Initializing scanner...';
            }
            
            // Stop the manual video stream since Quagga will create its own
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            // Clear the video element
            const videoContainer = document.getElementById('scanner-video');
            videoContainer.innerHTML = '';
            
            let detectionCount = {};
            
            // Quagga implementation as fallback
            Quagga.init({
                inputStream: {
                    type: "LiveStream",
                    target: document.querySelector('#scanner-video'),
                    constraints: {
                        width: { min: 640, ideal: 1280, max: 1920 },
                        height: { min: 480, ideal: 720, max: 1080 },
                        facingMode: "environment"
                    },
                    area: {
                        top: "0%",
                        right: "0%",
                        left: "0%",
                        bottom: "0%"
                    },
                    singleChannel: false
                },
                decoder: {
                    readers: ["code_39_reader", "code_128_reader", "ean_reader"],
                    debug: {
                        drawBoundingBox: true,
                        showFrequency: false,
                        drawScanline: true,
                        showPattern: false
                    }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: 2,
                frequency: 10,
                locate: true
            }, function(err) {
                if (err) {
                    console.error('Quagga error:', err);
                    if (scanStatus) {
                        scanStatus.textContent = 'Scanner error: ' + err.message;
                        scanStatus.style.background = 'rgba(220, 53, 69, 0.3)';
                        scanStatus.style.color = '#dc3545';
                    }
                    setTimeout(function() {
                        stopScanner();
                    }, 3000);
                    return;
                }
                
                console.log('Quagga started successfully');
                if (scanStatus) {
                    scanStatus.textContent = 'Ready to scan - point at VIN barcode';
                    scanStatus.style.background = 'rgba(0, 255, 136, 0.3)';
                    scanStatus.style.color = '#00ff88';
                }
                
                Quagga.start();
                
                // Fix Quagga's canvas/video sizing after it starts
                setTimeout(function() {
                    const videoContainer = document.getElementById('scanner-video');
                    if (videoContainer) {
                        const videos = videoContainer.querySelectorAll('video');
                        const canvases = videoContainer.querySelectorAll('canvas');
                        
                        videos.forEach(function(vid) {
                            vid.style.width = '100%';
                            vid.style.height = '100%';
                            vid.style.objectFit = 'contain';
                            vid.style.maxWidth = '100%';
                            vid.style.maxHeight = '100%';
                            vid.style.position = 'relative';
                        });
                        
                        canvases.forEach(function(canvas) {
                            canvas.style.width = '100%';
                            canvas.style.height = '100%';
                            canvas.style.objectFit = 'contain';
                            canvas.style.maxWidth = '100%';
                            canvas.style.maxHeight = '100%';
                            canvas.style.position = 'absolute';
                            canvas.style.top = '0';
                            canvas.style.left = '0';
                        });
                        
                        console.log('Resized Quagga elements:', videos.length, 'videos,', canvases.length, 'canvases');
                    }
                }, 500);
            });
            
            Quagga.onDetected(function(result) {
                if (!scannerActive) return;
                
                const code = result.codeResult.code.toUpperCase().trim();
                console.log('Quagga detected:', code, 'format:', result.codeResult.format);
                
                if (scanStatus) {
                    scanStatus.style.display = 'block';
                    scanStatus.textContent = 'Reading: ' + code.substring(0, 12) + '...';
                    scanStatus.style.background = 'rgba(255, 193, 7, 0.3)';
                    scanStatus.style.color = '#ffc107';
                }
                
                // Check if it looks like a VIN
                if (code.length >= 14 && /^[A-HJ-NPR-Z0-9]+$/.test(code)) {
                    const vin = code.length > 17 ? code.substring(0, 17) : code;
                    
                    // If exactly 17 characters, accept immediately
                    if (vin.length === 17) {
                        console.log('VIN confirmed (17 chars):', vin);
                        
                        if (scanStatus) {
                            scanStatus.textContent = 'âœ“ VIN Found!';
                            scanStatus.style.background = 'rgba(0, 255, 136, 0.3)';
                            scanStatus.style.color = '#00ff88';
                        }
                        
                        processScannedVIN(vin);
                        return;
                    }
                    
                    // For shorter codes, require 2 detections
                    detectionCount[code] = (detectionCount[code] || 0) + 1;
                    
                    if (detectionCount[code] >= 2) {
                        console.log('VIN confirmed (repeated):', vin);
                        
                        if (scanStatus) {
                            scanStatus.textContent = 'âœ“ VIN Found!';
                            scanStatus.style.background = 'rgba(0, 255, 136, 0.3)';
                            scanStatus.style.color = '#00ff88';
                        }
                        
                        processScannedVIN(vin);
                        return;
                    }
                }
            });
        }
        
        function processScannedVIN(vin) {
            if (!scannerActive) return;
            
            console.log('Processing VIN:', vin);
            
            // Fill VIN field
            const vinField = document.getElementById('vin_number');
            
            if (vinField) {
                vinField.value = vin;
                
                // Success beep
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    oscillator.frequency.value = 1000;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch(e) {
                    console.log('Audio not available');
                }
                
                // Stop scanner
                stopScanner();
                
                // Auto-decode VIN
                setTimeout(function() {
                    decodeVIN(vin);
                }, 100);
            }
        }
        
        function stopScanner() {
            scannerActive = false;
            const overlay = document.getElementById('scanner-overlay');
            overlay.classList.remove('active');
            
            // Stop video stream
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            // Stop scanning interval
            if (scanningInterval) {
                clearInterval(scanningInterval);
                scanningInterval = null;
            }
            
            // Stop Quagga if it was used
            if (typeof Quagga !== 'undefined') {
                try {
                    Quagga.stop();
                } catch(e) {
                    console.log('Quagga already stopped');
                }
            }
            
            // Clear video container
            const videoContainer = document.getElementById('scanner-video');
            if (videoContainer) {
                videoContainer.innerHTML = '';
            }
        }
        
        async function switchScanMode(mode) {
            if (scanMode === mode) return; // Already in this mode
            
            scanMode = mode;
            console.log('Switching to ' + mode + ' mode');
            
            // Update button visibility
            const textModeBtn = document.getElementById('text-scan-mode-btn');
            const barcodeModeBtn = document.getElementById('barcode-scan-mode-btn');
            
            if (mode === 'text') {
                if (textModeBtn) textModeBtn.style.display = 'none';
                if (barcodeModeBtn) barcodeModeBtn.style.display = 'inline-block';
            } else {
                if (textModeBtn) textModeBtn.style.display = 'inline-block';
                if (barcodeModeBtn) barcodeModeBtn.style.display = 'none';
            }
            
            // Stop current scanning
            if (scanningInterval) {
                clearInterval(scanningInterval);
                scanningInterval = null;
            }
            
            if (typeof Quagga !== 'undefined') {
                try {
                    Quagga.stop();
                } catch(e) {
                    console.log('Quagga already stopped');
                }
            }
            
            // Restart with new mode
            const videoElement = document.querySelector('#scanner-video video');
            if (videoElement && videoStream) {
                if (mode === 'text' && textDetectorSupported) {
                    startTextDetection(videoElement);
                } else {
                    // Restart barcode scanning
                    if ('BarcodeDetector' in window) {
                        startNativeBarcodeScanning(videoElement);
                    } else {
                        startQuaggaScanning(videoElement);
                    }
                }
            }
        }
        
        // Dynamic text resizing function
        function resizeTextToFit(element) {
            const container = element.parentElement;
            const elementId = element.id || '';
            
            // Determine starting font size based on field type
            let fontSize = 16; // Default starting font size (increased from 14)
            let minFontSize = 8; // Minimum font size
            
            // Special handling for different field types
            if (elementId === 'input_description_of_work') {
                fontSize = 13;
                minFontSize = 10;
            } else if (elementId.startsWith('input_q')) {
                // Quantity fields
                fontSize = 13;
                minFontSize = 9;
            } else if (elementId.startsWith('input_pn')) {
                // Part number fields - enable wrapping and adjust font size
                fontSize = 11;
                minFontSize = 7;
                element.style.whiteSpace = 'pre-wrap';
                element.style.wordWrap = 'break-word';
                element.style.wordBreak = 'break-word';
                element.style.overflowWrap = 'break-word';
                element.style.textAlign = 'left';
                element.style.lineHeight = '1.1';
                element.style.padding = '2px 3px';
                element.style.overflow = 'visible';
                element.style.justifyContent = 'flex-start';
                element.style.alignItems = 'flex-start';
            } else if (elementId.includes('tire') || elementId.includes('brakes') || elementId.includes('psi')) {
                // Tire and brake specs
                fontSize = 14;
                minFontSize = 10;
            }
            
            element.style.fontSize = fontSize + 'px';
            
            // For contenteditable elements (like VIN field), check differently
            if (element.contentEditable === 'true') {
                // Check if text overflows in contenteditable
                while ((element.scrollWidth > element.clientWidth || element.scrollHeight > element.clientHeight) && fontSize > minFontSize) {
                    fontSize -= 0.5;
                    element.style.fontSize = fontSize + 'px';
                }
            } else {
                // Regular input/textarea elements
                while ((element.scrollWidth > container.clientWidth || element.scrollHeight > container.clientHeight) && fontSize > minFontSize) {
                    fontSize -= 0.5;
                    element.style.fontSize = fontSize + 'px';
                }
            }
        }
        
        // Apply to all text inputs and textareas
        function setupAutoResize() {
            const inputs = document.querySelectorAll('.form-field-text-input input:not([type="hidden"]), .form-field-text-input textarea');
            inputs.forEach(input => {
                // Resize on input
                input.addEventListener('input', function(e) {
                    resizeTextToFit(this);
                });
                
                // Resize on focus out
                input.addEventListener('blur', function(e) {
                    resizeTextToFit(this);
                });
                
                // Initial resize if there's already content
                if (input.value) {
                    resizeTextToFit(input);
                }
            });
        }
        
        // Initialize when page loads - but after other scripts
        window.addEventListener('load', function() {
            setupAutoResize();
            setupTireTreadAutoFormat();
            setupBrakeAutoFormat();
            optimizeForAndroid();
        });
        
        // Android-specific optimizations (doesn't affect desktop)
        function optimizeForAndroid() {
            const isAndroid = /Android/i.test(navigator.userAgent);
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            
            if (isAndroid || isTouchDevice) {
                console.log('Android/Touch device detected - applying optimizations');
                
                // Prevent double-tap zoom on buttons
                document.querySelectorAll('button, .btn-professional').forEach(function(btn) {
                    btn.addEventListener('touchend', function(e) {
                        e.preventDefault();
                        this.click();
                    }, { passive: false });
                });
                
                // Improve input focus behavior on Android
                document.querySelectorAll('input, textarea, [contenteditable]').forEach(function(input) {
                    input.addEventListener('focus', function() {
                        // Scroll into view smoothly on Android
                        setTimeout(() => {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }, 300);
                    });
                });
                
                // Optimize scanner video for mobile
                const optimizeVideoStream = function() {
                    const video = document.querySelector('#scanner-video video');
                    if (video) {
                        video.setAttribute('playsinline', 'true');
                        video.setAttribute('webkit-playsinline', 'true');
                    }
                };
                
                // Monitor for scanner opening
                const observer = new MutationObserver(optimizeVideoStream);
                const scannerOverlay = document.getElementById('scanner-overlay');
                if (scannerOverlay) {
                    observer.observe(scannerOverlay, { childList: true, subtree: true });
                }
                
                // Reduce memory usage on Android by cleaning up old detection counts
                if (isAndroid) {
                    setInterval(function() {
                        // Force garbage collection hint by clearing old data
                        if (window.gc) window.gc();
                    }, 60000); // Every minute
                }
            }
        }
        
        // Auto-add "/32" to tire tread measurements
        function setupTireTreadAutoFormat() {
            const tireTreadFields = [
                document.getElementById('tire_lf'),
                document.getElementById('tire_rf'),
                document.getElementById('tire_lr'),
                document.getElementById('tire_rr')
            ];
            
            tireTreadFields.forEach(function(field) {
                if (!field) return;
                
                field.addEventListener('blur', function() {
                    let value = this.value.trim();
                    
                    // Only process if there's a value and it doesn't already have "/32"
                    if (value && !value.includes('/')) {
                        // Remove any existing "/32" just in case
                        value = value.replace('/32', '').trim();
                        
                        // If it's a number, add /32
                        if (/^\d+(\.\d+)?$/.test(value)) {
                            this.value = value + '/32';
                        }
                    }
                });
                
                // Also handle Enter key
                field.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur(); // Trigger the blur event which adds /32
                        
                        // Move to next field
                        const form = this.form;
                        const index = Array.prototype.indexOf.call(form, this);
                        if (form.elements[index + 1]) {
                            form.elements[index + 1].focus();
                        }
                    }
                });
            });
        }
        
        // Auto-add "B" to brake measurements
        function setupBrakeAutoFormat() {
            const brakeFields = [
                document.getElementById('brake_lf'),
                document.getElementById('brake_rf'),
                document.getElementById('brake_lr'),
                document.getElementById('brake_rr')
            ];
            
            brakeFields.forEach(function(field) {
                if (!field) return;
                
                field.addEventListener('blur', function() {
                    let value = this.value.trim().toUpperCase();
                    
                    // Only process if there's a value and it doesn't already end with "B"
                    if (value && !value.endsWith('B')) {
                        // If it's a number (with optional decimal), add B
                        if (/^\d+(\.\d+)?$/.test(value)) {
                            this.value = value + 'B';
                        }
                    }
                });
                
                // Also handle Enter key
                field.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur(); // Trigger the blur event which adds B
                        
                        // Move to next field
                        const form = this.form;
                        const index = Array.prototype.indexOf.call(form, this);
                        if (form.elements[index + 1]) {
                            form.elements[index + 1].focus();
                        }
                    }
                });
            });
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+Shift+V to open VIN scanner
            if (e.ctrlKey && e.shiftKey && e.key === 'V') {
                e.preventDefault();
                startScanner();
            }
            // ESC to close scanner
            if (e.key === 'Escape' && scannerActive) {
                e.preventDefault();
                stopScanner();
            }
        });
        
        document.getElementById('repair-order-form').addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('form-field-custom-checkbox')) {
                const checkbox = target.querySelector('input[type=checkbox]');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    // Use explicit add/remove instead of toggle
                    if (checkbox.checked) {
                        target.classList.add('checked');
                    } else {
                        target.classList.remove('checked');
                    }
                }
            }
        });
        
        // Function to ensure part numbers wrap properly for print
        function preparePartNumbersForPrint() {
            // Find all part number input fields
            const partNumberInputs = document.querySelectorAll('input[id^="input_pn"]');
            
            partNumberInputs.forEach(input => {
                const container = input.parentElement;
                if (!input.value || !container) return;
                
                const textLength = input.value.length;
                
                // Force wrapping styles on each field individually
                input.style.whiteSpace = 'pre-wrap';
                input.style.wordWrap = 'break-word';
                input.style.wordBreak = 'break-word';
                input.style.overflowWrap = 'break-word';
                input.style.textAlign = 'left';
                input.style.lineHeight = '1.1';
                input.style.padding = '2px 3px';
                input.style.overflow = 'visible';
                input.style.display = 'block';
                input.style.height = 'auto';
                input.style.minHeight = '100%';
                
                // Determine font size based on text length - each field sized independently
                let fontSize = 11; // Start with base size
                
                if (textLength > 50) {
                    fontSize = 7;
                } else if (textLength > 40) {
                    fontSize = 8;
                } else if (textLength > 30) {
                    fontSize = 9;
                } else if (textLength > 20) {
                    fontSize = 10;
                } else {
                    fontSize = 11;
                }
                
                input.style.fontSize = fontSize + 'px';
                input.style.setProperty('font-size', fontSize + 'px', 'important');
                
                // Force attribute update for print
                input.setAttribute('value', input.value);
            });
        }
        
        // Auto-resize text for print divs (similar to Mobile version)
        function autoResizePrintFields() {
            // Sync description field
            const descInput = document.getElementById('description');
            const descPrint = document.getElementById('print_services_performed');
            if (descInput && descPrint) {
                descPrint.textContent = descInput.value;
            }
            
            // Sync part number fields with dynamic font sizing
            for (let i = 1; i <= 22; i++) {
                const pnInput = document.getElementById('part' + i);
                const pnPrint = document.getElementById('print_part' + i);
                
                if (pnInput && pnPrint) {
                    const text = pnInput.textContent || '';
                    if (text) {
                        pnPrint.textContent = text;
                        
                        // Apply text wrapping styles
                        pnPrint.style.whiteSpace = 'normal';
                        pnPrint.style.wordBreak = 'break-word';
                        pnPrint.style.textAlign = 'left';
                        pnPrint.style.overflowWrap = 'break-word';
                        pnPrint.style.lineHeight = '1.2';
                        
                        // Dynamic font sizing based on text length - larger base sizes
                        const textLength = text.length;
                        let fontSize;
                        if (textLength > 25) {
                            fontSize = '9px';
                        } else if (textLength > 20) {
                            fontSize = '10px';
                        } else if (textLength > 15) {
                            fontSize = '11px';
                        } else if (textLength > 12) {
                            fontSize = '12px';
                        } else {
                            fontSize = '13px';
                        }
                        pnPrint.style.fontSize = fontSize;
                    }
                }
            }
            
            // Sync quantity fields
            for (let i = 1; i <= 22; i++) {
                const qInput = document.getElementById('qty' + i);
                const qPrint = document.getElementById('print_qty' + i);
                
                if (qInput && qPrint) {
                    const text = qInput.textContent || '';
                    if (text) {
                        qPrint.textContent = text;
                    }
                }
            }
        }
        
        // Print functionality
        document.getElementById('print-btn').addEventListener('click', function() {
            // Populate print divs before printing
            autoResizePrintFields();
            // Store original checkbox states for cleanup
            const originalCheckboxStates = [];
            
            // Prepare part numbers for wrapping
            preparePartNumbersForPrint();
            
            // First resize all text to fit before printing (except part numbers - handled separately)
            const inputs = document.querySelectorAll('.form-field-text-input input, .form-field-text-input textarea');
            inputs.forEach(input => {
                // Skip part number fields - they're handled by preparePartNumbersForPrint
                if (input.id && input.id.startsWith('input_pn')) {
                    return;
                }
                
                if (input.value) {
                    resizeTextToFit(input);
                    input.setAttribute('value', input.value);
                    // Force the style attribute to include font-size for print
                    input.style.fontSize = input.style.fontSize;
                }
            });
            
            // VIN field is now a regular input, no special handling needed
            
            // Handle checkboxes - ensure they show as checked in print
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                const div = checkbox.closest('.form-field-custom-checkbox');
                if (div) {
                    // Store original state for cleanup
                    originalCheckboxStates.push({
                        div: div,
                        checked: checkbox.checked,
                        originalBackground: div.style.background,
                        originalBackgroundImage: div.style.backgroundImage
                    });
                    
                    if (checkbox.checked) {
                        div.classList.add('checked');
                        // Force visibility for print
                        div.style.setProperty('background', 'black', 'important');
                        div.style.setProperty('background-image', 'url("data:image/svg+xml,%3csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 8 8\'%3e%3cpath fill=\'%23fff\' d=\'M6.564.75l-3.59 3.612-1.538-1.55L0 4.26 2.974 7.25 8 2.193z\'/%3e%3c/svg%3e")', 'important');
                        div.style.setProperty('background-repeat', 'no-repeat', 'important');
                        div.style.setProperty('background-position', 'center', 'important');
                        div.style.setProperty('background-size', '70% 70%', 'important');
                    } else {
                        div.classList.remove('checked');
                        div.style.setProperty('background', 'white', 'important');
                        div.style.removeProperty('background-image');
                    }
                }
            });
            
            // Function to clean up print styles
            function cleanupPrintStyles() {
                originalCheckboxStates.forEach(state => {
                    // Remove all forced inline styles
                    state.div.style.removeProperty('background');
                    state.div.style.removeProperty('background-image');
                    state.div.style.removeProperty('background-repeat');
                    state.div.style.removeProperty('background-position');
                    state.div.style.removeProperty('background-size');
                    
                    // Restore normal class-based styling
                    if (state.checked) {
                        state.div.classList.add('checked');
                    } else {
                        state.div.classList.remove('checked');
                    }
                });
            }
            
            // Listen for print dialog events
            window.addEventListener('afterprint', cleanupPrintStyles, { once: true });
            
            // Small delay to ensure styles are applied before printing
            setTimeout(() => {
                window.print();
                
                // Clean up the forced print styles after printing (fallback)
                setTimeout(() => {
                    cleanupPrintStyles();
                }, 500); // Give time for print dialog to close
            }, 100);
        });
    </script>

    <script>
        // Global variables for lock system and auth
        let currentWorkOrderNumber = null;
        let currentWatchingWorkOrder = null;
        let currentLockStatus = null;
        const DEBUG_LOCK_MODE = true;
        let database; // Global database reference
        let auth; // Global auth reference
        let currentUser = null; // Current authenticated user
        let companyId = null; // Company ID from user account
        let deviceName = null; // Device name for this session
        
        // Helper function to get company-scoped database path
        function getCompanyPath(path) {
            if (!companyId) {
                console.error('âš ï¸ companyId not set - using path without company scope');
                return path;
            }
            // Add company scope to workOrders and repairOrders paths
            if (path.startsWith('repairOrders/') || path.startsWith('repairOrders')) {
                return 'workOrders/' + companyId + '/' + path.replace('repairOrders/', '').replace('repairOrders', '');
            }
            return path;
        }
        
        // --- Firebase Connection ---
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyBFZ6W0mF05iRUiRTQblfXbBJLVtNQ3MMI",
                authDomain: "repair-order-db.firebaseapp.com",
                databaseURL: "https://repair-order-db-default-rtdb.firebaseio.com",
                projectId: "repair-order-db",
                storageBucket: "repair-order-db.appspot.com",
                messagingSenderId: "456395289187",
                appId: "1:456395289187:web:371db9b46db1435a5efe56"
            };

            firebase.initializeApp(firebaseConfig);

            database = firebase.database();
            auth = firebase.auth();
            const statusElement = document.getElementById('firebase-status');
            
            // Save original database.ref before wrapping it
            const originalDatabaseRef = database.ref.bind(database);

            // Authentication state listener
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    console.log('âœ… User authenticated:', user.email);
                    
                    // Get company ID from user's database entry - use original ref (no company scoping)
                    console.log('ðŸ” Attempting to read user data from:', 'users/' + user.uid);
                    originalDatabaseRef('users/' + user.uid).once('value').then(snapshot => {
                        console.log('ðŸ” Snapshot received:', snapshot.val());
                        const userData = snapshot.val();
                        if (userData && userData.companyId) {
                            companyId = userData.companyId;
                            console.log('âœ… Company ID:', companyId);
                            
                            // Check if device name is stored
                            const storedDeviceName = sessionStorage.getItem('deviceName_' + companyId);
                            if (storedDeviceName) {
                                deviceName = storedDeviceName;
                                initializeApp();
                            } else {
                                // Show device name modal
                                document.getElementById('device-name-modal').style.display = 'flex';
                            }
                        } else {
                            console.error('âŒ No company ID found for user');
                            alert('Error: Your account is not linked to a company. Please contact support.');
                            auth.signOut();
                        }
                    }).catch(error => {
                        console.error('âŒ Error reading user data:', error);
                        alert('Error: Could not load user data. ' + error.message);
                        auth.signOut();
                    });
                } else {
                    // User not logged in - show login screen
                    document.getElementById('login-screen').style.display = 'flex';
                    console.log('âš ï¸ User not authenticated');
                }
            });

            // Login form handler
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('company-email').value;
                const password = document.getElementById('company-password').value;
                const errorDiv = document.getElementById('login-error');
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    document.getElementById('login-screen').style.display = 'none';
                    errorDiv.style.display = 'none';
                } catch (error) {
                    console.error('Login error:', error);
                    errorDiv.textContent = 'Login failed: ' + error.message;
                    errorDiv.style.display = 'block';
                }
            });

            // Initialize app after authentication and device name
            function initializeApp() {
                console.log('ðŸš€ Initializing app for company:', companyId, 'device:', deviceName);
                
                // Set lock system variables
                myDeviceId = deviceName;
                myDeviceName = deviceName;
                
                // Hide modals
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('device-name-modal').style.display = 'none';
                
                // Load company info for this company
                loadCompanyInfo();
                
                // Monitor connection state
                setupConnectionMonitoring();
                
                // NOW fetch work orders after companyId is set
                fetchEntries();
            }

            function loadCompanyInfo() {
                database.ref('shopSettings/' + companyId + '/companyInfo').once('value').then(snapshot => {
                    const companyInfo = snapshot.val();
                    console.log('ðŸ” Company info check:', companyInfo);
                    
                    if (companyInfo) {
                        if (companyInfo.company_name) document.getElementById('company_name').textContent = companyInfo.company_name;
                        if (companyInfo.company_address) document.getElementById('company_address').textContent = companyInfo.company_address;
                        if (companyInfo.company_contact) document.getElementById('company_contact').textContent = companyInfo.company_contact;
                        if (companyInfo.company_website) document.getElementById('company_website').textContent = companyInfo.company_website;
                        console.log('âœ… Loaded company info from Firebase - hiding button');
                        document.getElementById('save-company-btn').style.display = 'none';
                        document.getElementById('company-hint').style.display = 'none';
                    } else {
                        console.log('âš ï¸ No company info found - showing setup button');
                        document.getElementById('save-company-btn').style.display = 'inline-block';
                        document.getElementById('company-hint').style.display = 'block';
                    }
                }).catch(err => {
                    console.log('âŒ Error loading company info:', err);
                    document.getElementById('save-company-btn').style.display = 'inline-block';
                    document.getElementById('company-hint').style.display = 'block';
                });
            }

            function setupConnectionMonitoring() {
                const connectedRef = database.ref('.info/connected');
                connectedRef.on('value', (snap) => {
                    if (snap.val() === true) {
                        statusElement.textContent = 'Firebase Connected (' + deviceName + ')';
                        statusElement.className = 'connected';
                        
                        if (currentWorkOrderNumber && currentLockStatus === 'locked-by-me') {
                            database.ref('workOrders/' + companyId + '/' + currentWorkOrderNumber + '/lockedBy').once('value').then(snapshot => {
                                const lockedBy = snapshot.val();
                                if (lockedBy !== deviceName) {
                                    console.warn('âš ï¸ Lost lock during disconnect');
                                    currentLockStatus = 'unlocked';
                                    currentWorkOrderNumber = null;
                                    disableForm('Connection lost');
                                } else if (DEBUG_LOCK_MODE) {
                                    console.log('âœ… Lock still valid after reconnect');
                                }
                            });
                        }
                    } else {
                        statusElement.textContent = 'Firebase Disconnected';
                        statusElement.className = 'disconnected';
                        
                        if (currentWorkOrderNumber && currentLockStatus === 'locked-by-me') {
                            stopHeartbeat();
                            if (DEBUG_LOCK_MODE) console.log('ðŸ”Œ Disconnected - heartbeat stopped');
                        }
                    }
                });
            }

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            const statusElement = document.getElementById('firebase-status');
            statusElement.textContent = 'Firebase Initialization Failed';
            statusElement.className = 'disconnected';
        }

        // Save device name function
        function saveDeviceName() {
            const input = document.getElementById('device-name-input');
            const name = input.value.trim();
            
            if (!name) {
                alert('Please enter a device name');
                return;
            }
            
            deviceName = name;
            // Store in sessionStorage for this browser session
            sessionStorage.setItem('deviceName_' + companyId, deviceName);
            
            // Optionally save to Firebase for future reference - use original ref
            const originalRef = firebase.database().ref.bind(firebase.database());
            originalRef('users/' + currentUser.uid + '/devices/' + Date.now()).set({
                deviceName: deviceName,
                lastUsed: new Date().toISOString()
            });
            
            initializeApp();
        }
    </script>

    <script>
        // --- VIN Field Handling ---
        const vinField = document.getElementById('vin_number');

        // Auto-uppercase VIN input
        if (vinField) {
            vinField.addEventListener('input', function() {
                this.value = this.value.toUpperCase();
            });
        }

        vinField.addEventListener('focus', function() {
            // Auto-select VIN for easy copying when clicked
            this.select();
        });
        
        // VIN hover overlay to show last 8 characters in bold
        const vinOverlay = document.getElementById('vin-overlay');
        
        vinField.addEventListener('mouseenter', function(e) {
            const vin = this.value.trim();
            if (vin.length >= 8) {
                const firstPart = vin.substring(0, vin.length - 8);
                const lastEight = vin.substring(vin.length - 8);
                
                vinOverlay.innerHTML = `<span class="vin-first-part">${firstPart}</span><span class="vin-last-eight">${lastEight}</span>`;
                
                const rect = this.getBoundingClientRect();
                vinOverlay.style.left = rect.left + 'px';
                vinOverlay.style.top = (rect.bottom + 5) + 'px';
                vinOverlay.classList.add('show');
            }
        });
        
        vinField.addEventListener('mouseleave', function() {
            vinOverlay.classList.remove('show');
        });
    </script>

    <script>
        // --- VIN Decoder (NHTSA API) ---
        let vinDecodeTimeout = null;
        const vinStatusIndicator = document.createElement('div');
        vinStatusIndicator.id = 'vin-decode-status';
        vinStatusIndicator.style.cssText = 'position: fixed; top: 30px; right: 10px; padding: 8px 12px; background: #2d2d2d; border: 1px solid #00bfff; border-radius: 6px; color: #00bfff; font-size: 12px; z-index: 102; display: none; box-shadow: 0 2px 8px rgba(0,191,255,0.3);';
        document.body.appendChild(vinStatusIndicator);

        function showVinStatus(message, color = '#00bfff') {
            vinStatusIndicator.textContent = message;
            vinStatusIndicator.style.color = color;
            vinStatusIndicator.style.borderColor = color;
            vinStatusIndicator.style.display = 'block';
            setTimeout(() => {
                vinStatusIndicator.style.display = 'none';
            }, 3000);
        }

        async function decodeVIN(vin) {
            // Validate VIN format (17 characters, alphanumeric, no I, O, Q)
            vin = vin.toUpperCase().trim();
            if (vin.length !== 17) return;
            if (!/^[A-HJ-NPR-Z0-9]{17}$/.test(vin)) {
                showVinStatus('Invalid VIN format', '#ff4757');
                return;
            }

            showVinStatus('Decoding VIN...', '#00bfff');

            try {
                const response = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVin/${vin}?format=json`);
                if (!response.ok) throw new Error('API request failed');
                
                const data = await response.json();
                if (!data.Results) throw new Error('No results from API');

                // Extract relevant vehicle information
                const results = data.Results;
                const vehicleInfo = {};
                
                results.forEach(item => {
                    if (item.Value && item.Value !== 'Not Applicable' && item.Value !== '') {
                        vehicleInfo[item.Variable] = item.Value;
                    }
                });

                // Auto-fill fields only if they are empty
                const yearField = document.getElementById('year');
                const makeField = document.getElementById('make');
                const modelField = document.getElementById('model');
                const trimField = document.getElementById('trim');
                const engineSizeField = document.getElementById('engine_size');
                const mfgDateField = document.getElementById('mfg_date');

                // Fill individual year/make/model/trim fields
                if (yearField && vehicleInfo['Model Year'] && !yearField.value) {
                    yearField.value = vehicleInfo['Model Year'];
                }
                if (makeField && vehicleInfo['Make'] && !makeField.value) {
                    makeField.value = vehicleInfo['Make'].toUpperCase();
                }
                if (modelField && vehicleInfo['Model'] && !modelField.value) {
                    modelField.value = vehicleInfo['Model'].toUpperCase();
                }
                
                // Extract manufacturer date from VIN
                if (mfgDateField && !mfgDateField.value) {
                    // VIN 10th character = model year code
                    const yearCode = vin.charAt(9);
                    // Try to get plant info from NHTSA data
                    let mfgDate = '';
                    // Format: month/year (country) e.g., "4/15 (Mexico)"
                    // Since NHTSA doesn't provide month, use year with last 2 digits
                    if (vehicleInfo['Model Year']) {
                        const yearShort = vehicleInfo['Model Year'].toString().slice(-2);
                        mfgDate = yearShort; // Just year (e.g., "15" for 2015)
                    }
                    // Add plant country if available
                    if (vehicleInfo['Plant Country']) {
                        mfgDate += ' (' + vehicleInfo['Plant Country'] + ')';
                    }
                    if (mfgDate) {
                        mfgDateField.value = mfgDate;
                    }
                }
                
                // Try multiple trim fields - NHTSA uses different field names
                if (trimField && !trimField.value) {
                    let trimValue = '';
                    if (vehicleInfo['Trim']) trimValue = vehicleInfo['Trim'];
                    else if (vehicleInfo['Trim2']) trimValue = vehicleInfo['Trim2'];
                    else if (vehicleInfo['Series']) trimValue = vehicleInfo['Series'];
                    if (trimValue) {
                        trimField.value = trimValue.toUpperCase();
                    }
                }

                // Build engine size string
                let engineSize = '';
                if (vehicleInfo['Displacement (L)']) {
                    // Round to 1 decimal place for cleaner display
                    const displacement = parseFloat(vehicleInfo['Displacement (L)']);
                    if (!isNaN(displacement)) {
                        engineSize = displacement.toFixed(1) + 'L';
                    }
                }
                if (vehicleInfo['Engine Number of Cylinders']) {
                    engineSize += (engineSize ? ' ' : '') + vehicleInfo['Engine Number of Cylinders'] + ' CYL';
                }
                
                // Only fill if field is empty
                if (engineSizeField && !engineSizeField.value && engineSize) {
                    engineSizeField.value = engineSize.toUpperCase();
                }

                // Show success message
                if (yearMakeModel || engineSize) {
                    showVinStatus('VIN decoded successfully!', '#00ff88');
                } else {
                    showVinStatus('VIN valid but no data found', '#ffc107');
                }

            } catch (error) {
                console.error('VIN decode error:', error);
                showVinStatus('VIN decode failed', '#ff4757');
            }
        }

        // Add VIN decoder to the VIN field
        if (vinField) {
            vinField.addEventListener('input', function() {
                // Clear previous timeout
                if (vinDecodeTimeout) clearTimeout(vinDecodeTimeout);
                
                // Get current VIN value
                const currentVin = this.value.trim();
                
                // If VIN is 17 characters, decode after 1 second of no typing
                if (currentVin.length === 17) {
                    vinDecodeTimeout = setTimeout(() => {
                        decodeVIN(currentVin);
                    }, 1000); // Wait 1 second after user stops typing
                }
            });

            // Also decode on paste
            vinField.addEventListener('paste', function(e) {
                setTimeout(() => {
                    const currentVin = this.value.trim();
                    if (currentVin.length === 17) {
                        decodeVIN(currentVin);
                    }
                }, 500);
            });
        }
    </script>

    <script>
        // --- ZIP Code to County Lookup ---
        let zipLookupTimeout = null;
        const addressField = document.getElementById('customer_address');
        const countyField = document.getElementById('county');

        async function lookupCountyFromZip(zipCode) {
            console.log('=== County Lookup Started ===');
            console.log('ZIP code:', zipCode);
            console.log('County field current value:', countyField ? countyField.value : 'field not found');
            
            // Validate ZIP code format (5 digits or 5+4 format)
            zipCode = zipCode.trim();
            const zipMatch = zipCode.match(/\b(\d{5})(?:-\d{4})?\b/);
            if (!zipMatch) {
                console.log('Invalid ZIP format');
                return;
            }

            const zip = zipMatch[1]; // Extract 5-digit ZIP
            console.log('Extracted 5-digit ZIP:', zip);
            
            // Check if we already looked up this ZIP
            if (zip === lastZipUsedForCounty) {
                console.log('County already filled for this ZIP, skipping lookup');
                return;
            }

            try {
                console.log('Fetching coordinates from zippopotam.us...');
                // First get coordinates from zippopotam.us
                const zipResponse = await fetch(`https://api.zippopotam.us/us/${zip}`);
                if (!zipResponse.ok) {
                    console.log('ZIP not found in zippopotam.us');
                    throw new Error('ZIP not found');
                }
                
                const zipData = await zipResponse.json();
                console.log('Zippopotam data received:', zipData);
                
                if (zipData.places && zipData.places.length > 0) {
                    const lat = zipData.places[0].latitude;
                    const lon = zipData.places[0].longitude;
                    console.log('Coordinates:', lat, lon);
                    
                    // Now use FCC API to get actual county name (via CORS proxy for local file compatibility)
                    console.log('Fetching county from FCC API...');
                    // Use CORS proxy to bypass local file CORS restrictions
                    const corsProxy = 'https://corsproxy.io/?';
                    const censusResponse = await fetch(`${corsProxy}https://geo.fcc.gov/api/census/area?lat=${lat}&lon=${lon}&format=json`);
                    if (censusResponse.ok) {
                        const censusData = await censusResponse.json();
                        console.log('FCC data received:', censusData);
                        
                        if (censusData.results && censusData.results.length > 0) {
                            let countyName = censusData.results[0].county_name;
                            console.log('Raw county name:', countyName);
                            
                            // Remove " County" suffix if present for cleaner display
                            countyName = countyName.replace(/ County$/i, '');
                            console.log('Cleaned county name:', countyName);
                            
                            // Only fill if county field is empty
                            if (countyField) {
                                if (!countyField.value.trim()) {
                                    countyField.value = countyName.toUpperCase();
                                    lastZipUsedForCounty = zip; // Track this ZIP
                                    console.log(`âœ“ SUCCESS: County filled with: ${countyName.toUpperCase()}`);
                                } else {
                                    lastZipUsedForCounty = zip; // Track even if already filled
                                    console.log(`County field already has value: ${countyField.value}`);
                                }
                            } else {
                                console.log('ERROR: County field not found!');
                            }
                            console.log('=== County Lookup Complete ===');
                            return;
                        }
                    }
                }
                
                // If we get here, county lookup failed
                console.log(`Could not find county for ZIP ${zip}`);
                console.log('=== County Lookup Failed ===');
                
            } catch (error) {
                console.log('ZIP/County lookup error:', error);
                console.log('=== County Lookup Failed ===');
                // Fail silently - don't show error to user
            }
        }

        function extractAndLookupZip() {
            if (!addressField) return;
            
            const address = addressField.value;
            if (!address) return;

            console.log('Checking address for ZIP code:', address);

            // Extract ZIP code from address (supports 5-digit or ZIP+4 format)
            // Look for 5 digits optionally followed by -4 more digits
            const zipMatch = address.match(/\b(\d{5})(?:-\d{4})?\b/);
            
            if (zipMatch) {
                const zipCode = zipMatch[0];
                console.log('Found ZIP code:', zipCode);
                
                // Clear previous timeout
                if (zipLookupTimeout) clearTimeout(zipLookupTimeout);
                
                // Lookup county after 1.5 seconds of no typing (give time to finish typing)
                zipLookupTimeout = setTimeout(() => {
                    lookupCountyFromZip(zipCode);
                }, 1500);
            } else {
                console.log('No ZIP code found in address');
            }
        }

        // Add event listeners to address field
        if (addressField) {
            addressField.addEventListener('input', extractAndLookupZip);
            addressField.addEventListener('blur', function() {
                // On blur, immediately try to lookup (don't wait)
                if (zipLookupTimeout) clearTimeout(zipLookupTimeout);
                const address = addressField.value;
                const zipMatch = address.match(/\b(\d{5})(?:-\d{4})?\b/);
                if (zipMatch) {
                    lookupCountyFromZip(zipMatch[0]);
                }
            });
            addressField.addEventListener('paste', function() {
                setTimeout(extractAndLookupZip, 200);
            });
            
            console.log('County auto-fill: Listening to address field');
        }
    </script>

    <script>
        // --- Firebase Entries Handling ---
// Use database reference from auth script (defined globally)
const db = database; // Alias for backward compatibility

// Override db.ref to automatically add company scoping
const originalDbRef = database.ref.bind(database);
database.ref = function(path) {
    return originalDbRef(getCompanyPath(path));
};
db.ref = database.ref; // Ensure alias also uses the wrapped version

const saveBtn = document.getElementById('save-btn');
const entrySearch = document.getElementById('entry-search');
const entriesDropdown = document.getElementById('entries-dropdown');
const deleteEntryBtn = document.getElementById('delete-entry-btn');
const newOrderBtn = document.getElementById('new-order-btn');
let entriesCache = {};
let currentEditKey = null;
// currentWorkOrderNumber and currentWatchingWorkOrder declared at top of Firebase script
let lastZipUsedForCounty = ''; // Track ZIP code for smart county updates
let currentWorkOrderListener = null; // Firebase listener for current work order
let lastKnownTimestamp = null; // Track last timestamp to detect updates

// --- LOCK SYSTEM ---
// DEBUG_LOCK_MODE declared at top of Firebase script
const LOCK_TIMEOUT = DEBUG_LOCK_MODE ? 60000 : 900000; // 1 min (debug) or 15 min (production)
const HEARTBEAT_INTERVAL = 30000; // 30 seconds
const LOCK_EXPIRY_TIME = 90000; // 90 seconds - lock expires if no heartbeat

// Use deviceName from auth instead of localStorage
let myDeviceId = deviceName; // Will be set after login
let myDeviceName = deviceName; // Will be set after login
let lockHeartbeatInterval = null;
// currentLockStatus declared at top of Firebase script

// Device ID and name now set from auth login flow (deviceName variable)
// myDeviceId and myDeviceName will be updated after authentication

if (DEBUG_LOCK_MODE) console.log('ðŸ”§ Lock system initialized');

// Auto-fill date field with current date on page load
function setCurrentDate() {
    const dateField = document.getElementById('date');
    if (dateField && !dateField.value) { // Only set if field is empty
        const today = new Date();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const year = today.getFullYear();
        dateField.value = `${month}/${day}/${year}`;
    }
}

// Track field changes for smart merging
// --- LOCK MANAGEMENT FUNCTIONS ---

// Acquire lock for a work order
function acquireLock(workOrderNumber, forceOverride = false) {
    if (!workOrderNumber) return Promise.reject('No work order number');
    
    if (DEBUG_LOCK_MODE) console.log('ðŸ”’ Attempting to acquire lock for:', workOrderNumber);
    
    return db.ref('repairOrders/' + workOrderNumber).once('value').then(snapshot => {
        const data = snapshot.val();
        if (!data) return Promise.reject('Work order not found');
        
        // Check if already locked by someone else
        if (data.lockedBy && data.lockedBy !== myDeviceId && !forceOverride) {
            // Check if lock is stale (no heartbeat)
            const lockAge = Date.now() - (data.lockHeartbeat || data.lockedAt || 0);
            
            if (lockAge < LOCK_EXPIRY_TIME) {
                // Lock is fresh - cannot acquire
                if (DEBUG_LOCK_MODE) console.log('ðŸ”’ Lock held by:', data.lockedByName, '(age:', Math.round(lockAge/1000), 'sec)');
                return Promise.reject({ 
                    locked: true, 
                    lockedBy: data.lockedByName || 'Another device',
                    lockAge: lockAge
                });
            } else {
                // Lock is stale - can take over
                if (DEBUG_LOCK_MODE) console.log('â˜ ï¸ Lock expired (age:', Math.round(lockAge/1000), 'sec) - taking over');
            }
        }
        
        // Acquire lock - ONLY update lock fields
        return db.ref('repairOrders/' + workOrderNumber).update({
            lockedBy: myDeviceId,
            lockedByName: myDeviceName,
            lockedAt: firebase.database.ServerValue.TIMESTAMP,
            lockHeartbeat: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            // Set up auto-release on disconnect
            db.ref('repairOrders/' + workOrderNumber + '/lockedBy').onDisconnect().remove();
            db.ref('repairOrders/' + workOrderNumber + '/lockedByName').onDisconnect().remove();
            db.ref('repairOrders/' + workOrderNumber + '/lockHeartbeat').onDisconnect().remove();
            db.ref('repairOrders/' + workOrderNumber + '/lockedAt').onDisconnect().remove();
            
            // Start heartbeat
            startHeartbeat(workOrderNumber);
            
            currentLockStatus = 'locked-by-me';
            trackActiveLock(); // Track lock in sessionStorage for refresh cleanup
            if (DEBUG_LOCK_MODE) console.log('âœ… Lock acquired successfully for WO:', workOrderNumber);
            
            // Don't call enableForm here - let the caller handle UI
            // This prevents duplicate/conflicting UI updates
            
            return true;
        });
    });
}

// Release lock for a work order
function releaseLock(workOrderNumber) {
    if (!workOrderNumber) return Promise.resolve();
    
    if (DEBUG_LOCK_MODE) console.log('ðŸ”“ Releasing lock for:', workOrderNumber);
    
    // Stop heartbeat
    stopHeartbeat();
    
    // Remove lock from database
    return db.ref('repairOrders/' + workOrderNumber).update({
        lockedBy: null,
        lockedByName: null,
        lockHeartbeat: null,
        lockedAt: null
    }).then(() => {
        // Cancel onDisconnect
        db.ref('repairOrders/' + workOrderNumber + '/lockedBy').onDisconnect().cancel();
        db.ref('repairOrders/' + workOrderNumber + '/lockedByName').onDisconnect().cancel();
        db.ref('repairOrders/' + workOrderNumber + '/lockHeartbeat').onDisconnect().cancel();
        db.ref('repairOrders/' + workOrderNumber + '/lockedAt').onDisconnect().cancel();
        
        currentLockStatus = 'unlocked';
        trackActiveLock(); // Clear lock tracking in sessionStorage
        if (DEBUG_LOCK_MODE) console.log('âœ… Lock released successfully');
    }).catch(err => {
        console.error('Error releasing lock:', err);
    });
}

// Start sending heartbeats
function startHeartbeat(workOrderNumber) {
    stopHeartbeat(); // Clear any existing interval
    
    lockHeartbeatInterval = setInterval(() => {
        db.ref('repairOrders/' + workOrderNumber + '/lockHeartbeat')
            .set(firebase.database.ServerValue.TIMESTAMP)
            .then(() => {
                if (DEBUG_LOCK_MODE) console.log('ðŸ’“ Heartbeat sent');
            })
            .catch(err => {
                console.error('Heartbeat failed:', err);
                stopHeartbeat();
            });
    }, HEARTBEAT_INTERVAL);
    
    if (DEBUG_LOCK_MODE) console.log('ðŸ’“ Heartbeat started (every', HEARTBEAT_INTERVAL/1000, 'sec)');
}

// Stop sending heartbeats
function stopHeartbeat() {
    if (lockHeartbeatInterval) {
        clearInterval(lockHeartbeatInterval);
        lockHeartbeatInterval = null;
        if (DEBUG_LOCK_MODE) console.log('ðŸ’“ Heartbeat stopped');
    }
}

// Disable form (read-only mode)
function disableForm(lockedByName) {
    currentLockStatus = 'locked-by-other';
    
    // Disable all inputs
    const form = document.getElementById('repair-order-form');
    form.querySelectorAll('input, textarea, [contenteditable]').forEach(el => {
        if (el.hasAttribute('contenteditable')) {
            // Special handling for VIN field - keep selectable but prevent editing
            if (el.id === 'vin_editable') {
                el.setAttribute('contenteditable', 'false');
                el.style.cursor = 'text'; // Allow text cursor for selection
                el.style.userSelect = 'text'; // Explicitly allow text selection
                el.style.webkitUserSelect = 'text';
                // Remove HTML formatting to allow proper text selection, but keep highlight via CSS
                const vinText = el.textContent;
                el.textContent = vinText; // Converts HTML to plain text
                // Apply gradient background to highlight last 8 characters visually
                if (vinText.length > 8) {
                    const percentStart = ((vinText.length - 8) / vinText.length) * 100;
                    el.style.background = `linear-gradient(to right, #f0f0f0 0%, #f0f0f0 ${percentStart}%, yellow ${percentStart}%, yellow 100%)`;
                } else {
                    el.style.backgroundColor = 'yellow';
                }
            } else {
                el.setAttribute('contenteditable', 'false');
                el.style.backgroundColor = '#f0f0f0';
                el.style.cursor = 'not-allowed';
            }
        } else {
            el.disabled = true;
        }
    });
    
    // Disable checkboxes
    form.querySelectorAll('.form-field-custom-checkbox').forEach(el => {
        el.style.pointerEvents = 'none';
        el.style.opacity = '0.5';
    });
    
    // Disable Save and Delete buttons, but keep New Order and Print enabled
    saveBtn.disabled = true;
    deleteEntryBtn.disabled = true;
    // Keep New Order and Print enabled - they don't modify locked work order
    newOrderBtn.disabled = false;
    document.getElementById('print-btn').disabled = false;
    
    // Show lock message
    const statusDiv = document.getElementById('save-status');
    statusDiv.textContent = 'ï¿½ Locked by: ' + lockedByName;
    statusDiv.style.color = '#ff4757';
    statusDiv.style.fontWeight = 'bold';
    statusDiv.classList.add('locked-readonly');
    
    // Show force unlock button
    const forceUnlockBtn = document.getElementById('force-unlock-btn');
    forceUnlockBtn.classList.add('visible');
    
    if (DEBUG_LOCK_MODE) console.log('ï¿½ Form disabled - locked by:', lockedByName);
}

// Enable form (editable mode)
function enableForm() {
    currentLockStatus = 'locked-by-me';
    
    // Enable all inputs
    const form = document.getElementById('repair-order-form');
    form.querySelectorAll('input, textarea, [contenteditable]').forEach(el => {
        if (el.hasAttribute('contenteditable')) {
            el.setAttribute('contenteditable', 'true');
            el.style.backgroundColor = '';
            el.style.cursor = '';
        } else {
            el.disabled = false;
        }
    });
    
    // Enable checkboxes
    form.querySelectorAll('.form-field-custom-checkbox').forEach(el => {
        el.style.pointerEvents = '';
        el.style.opacity = '';
    });
    
    // Enable buttons
    saveBtn.disabled = false;
    deleteEntryBtn.disabled = false;
    newOrderBtn.disabled = false;
    document.getElementById('print-btn').disabled = false;
    
    // Update status
    const statusDiv = document.getElementById('save-status');
    statusDiv.textContent = 'âœï¸ You are editing';
    statusDiv.style.color = '#00ff88';
    statusDiv.style.fontWeight = 'normal';
    statusDiv.classList.remove('locked-readonly');
    
    // Hide force unlock button
    const forceUnlockBtn = document.getElementById('force-unlock-btn');
    forceUnlockBtn.classList.remove('visible');
    
    if (DEBUG_LOCK_MODE) console.log('âœ… Form enabled - you have control');
}

// Real-time sync - watch for updates to current work order
function startWatchingWorkOrder(workOrderNumber) {
    // Stop any existing listener first
    stopWatchingWorkOrder();
    
    if (!workOrderNumber) {
        currentWatchingWorkOrder = null;
        return;
    }
    
    // Track which work order we're watching (even in read-only mode)
    currentWatchingWorkOrder = workOrderNumber;
    console.log('Starting real-time sync for work order:', workOrderNumber);
    
    // Listen for changes to this specific work order
    currentWorkOrderListener = db.ref('repairOrders/' + workOrderNumber).on('value', function(snapshot) {
        const updatedData = snapshot.val();
        
        if (!updatedData) return;
        
        // Debug: Log timestamp comparison
        if (DEBUG_LOCK_MODE) {
            console.log('ðŸ“Š Timestamp check:', {
                lastKnown: lastKnownTimestamp,
                current: updatedData.timestamp,
                changed: updatedData.timestamp !== lastKnownTimestamp,
                lockStatus: currentLockStatus
            });
        }
        
        // Edge fix: Ignore updates for work orders we're no longer watching
        // This prevents race conditions when switching rapidly
        if (currentWatchingWorkOrder !== workOrderNumber) {
            if (DEBUG_LOCK_MODE) console.log('â­ï¸ Ignoring update for old WO:', workOrderNumber);
            return;
        }
        
        // CHECK TIMESTAMP FIRST - Auto-update if data changed (regardless of lock status)
        if (updatedData.timestamp && updatedData.timestamp !== lastKnownTimestamp) {
            if (currentLockStatus === 'locked-by-other') {
                // Someone else is editing and saved changes - auto-update our read-only view
                console.log('ðŸ”„ Other user saved changes - auto-refreshing read-only view');
                loadWorkOrderData(updatedData);
                lastKnownTimestamp = updatedData.timestamp;
                
                // Show brief notification
                const status = document.getElementById('save-status');
                const oldText = status.textContent;
                status.textContent = 'ðŸ”„ Updated by ' + (updatedData.lockedByName || 'another user');
                status.style.color = '#00bfff';
                setTimeout(() => {
                    status.textContent = oldText;
                    status.style.color = '#ff4757';
                }, 2000);
                // Don't return - continue to check lock status below
            } else if (currentLockStatus === 'locked-by-me') {
                // We have the lock and data changed (we probably just saved)
                console.log('ðŸ”„ Data updated (we saved) - refreshing timestamp');
                lastKnownTimestamp = updatedData.timestamp;
            } else {
                // No lock status yet, just update timestamp
                lastKnownTimestamp = updatedData.timestamp;
            }
        }
        
        // Initialize timestamp on first load
        if (!lastKnownTimestamp && updatedData.timestamp) {
            lastKnownTimestamp = updatedData.timestamp;
        }
        
        // Now check lock status
        if (updatedData.lockedBy && updatedData.lockedBy !== myDeviceId) {
            // Check if lock is still valid
            const lockAge = Date.now() - (updatedData.lockHeartbeat || updatedData.lockedAt || 0);
            
            if (lockAge < LOCK_EXPIRY_TIME) {
                // Locked by someone else - show read-only
                // BUT: Don't override if we think we have the lock (possible Firebase delay)
                if (currentLockStatus === 'locked-by-me') {
                    console.warn('âš ï¸ Watcher sees different lock, but we think we have it. Re-checking...');
                    // Double-check lock ownership
                    db.ref('repairOrders/' + workOrderNumber + '/lockedBy').once('value').then(snap => {
                        if (snap.val() !== myDeviceId) {
                            console.error('âŒ Confirmed: Lost lock to another user');
                            disableForm(updatedData.lockedByName || 'Another user');
                        } else if (DEBUG_LOCK_MODE) {
                            console.log('âœ… Confirmed: We still have the lock');
                        }
                    });
                } else if (currentLockStatus !== 'locked-by-other') {
                    document.getElementById('save-status').textContent = 'ï¿½ ' + (updatedData.lockedByName || 'Another user') + ' started editing';
                    document.getElementById('save-status').style.color = '#ff4757';
                    setTimeout(() => {
                        if (currentLockStatus === 'locked-by-other') {
                            document.getElementById('save-status').textContent = 'ï¿½ Locked by: ' + (updatedData.lockedByName || 'Another user');
                        }
                    }, 3000);
                    disableForm(updatedData.lockedByName || 'Another user');
                }
            } else {
                // Lock expired - try to acquire it
                if (currentLockStatus === 'locked-by-other') {
                    acquireLock(workOrderNumber).then(() => {
                        currentWorkOrderNumber = workOrderNumber;
                        currentLockStatus = 'locked-by-me';
                        // Reload data to show changes made by other user
                        loadWorkOrderData(updatedData);
                        enableForm(); // Must explicitly enable form
                        document.getElementById('save-status').textContent = 'âœ… Work order unlocked - reloaded with latest changes';
                        document.getElementById('save-status').style.color = '#00ff88';
                        setTimeout(() => {
                            document.getElementById('save-status').textContent = 'âœï¸ You are editing';
                        }, 3000);
                    }).catch(err => {
                        console.error('Failed to acquire expired lock:', err);
                    });
                }
            }
        } else if (!updatedData.lockedBy && currentLockStatus === 'locked-by-other') {
            // Lock was released - try to acquire it and reload data
            acquireLock(workOrderNumber).then(() => {
                currentWorkOrderNumber = workOrderNumber;
                currentLockStatus = 'locked-by-me';
                // Reload data to show changes made by other user
                loadWorkOrderData(updatedData);
                enableForm(); // Must explicitly enable form
                document.getElementById('save-status').textContent = 'âœ… Work order unlocked - reloaded with latest changes';
                document.getElementById('save-status').style.color = '#00ff88';
                setTimeout(() => {
                    document.getElementById('save-status').textContent = 'âœï¸ You are editing';
                }, 3000);
            }).catch(err => {
                console.error('Failed to acquire released lock:', err);
            });
        }
    });
}

function stopWatchingWorkOrder() {
    if (currentWorkOrderListener && currentWatchingWorkOrder) {
        db.ref('repairOrders/' + currentWatchingWorkOrder).off('value', currentWorkOrderListener);
        if (DEBUG_LOCK_MODE) console.log('ðŸ›‘ Stopped watching work order:', currentWatchingWorkOrder);
        currentWorkOrderListener = null;
    }
    currentWatchingWorkOrder = null;
    lastKnownTimestamp = null;
    
    // Also stop heartbeat when stopping watcher (Edge fix)
    stopHeartbeat();
}

// Helper function to load work order data into form
function loadWorkOrderData(entry) {
    if (!entry) return;
    
    console.log('Loading work order data...', entry);
    
    // Clear form first
    clearPartsFields();
    
    // Load company info if exists in this work order
    if (entry.company_name) document.getElementById('company_name').textContent = entry.company_name;
    if (entry.company_address) document.getElementById('company_address').textContent = entry.company_address;
    if (entry.company_contact) document.getElementById('company_contact').textContent = entry.company_contact;
    if (entry.company_website) document.getElementById('company_website').textContent = entry.company_website;
    
    // Define field mapping - maps Firebase keys to form field IDs
    // Supports both OLD format (input_customer_name) and NEW format (customer_name)
    const fieldMapping = {
        // Header fields
        'date': 'date',
        'input_date': 'date',  // OLD FORMAT
        'ro_number': 'ro_number',
        'input_ro': 'ro_number',  // OLD FORMAT
        'stock_number': 'stock_number',
        'input_stock_number': 'stock_number',  // OLD FORMAT (if it exists)
        'input_stock_': 'stock_number',  // OLD FORMAT (actual field name from mobile)
        'plate': 'plate',
        'input_plate_number': 'plate',  // OLD FORMAT
        'odometer': 'odometer',
        'input_mileage': 'odometer',  // OLD FORMAT (if it exists)
        'input_odometer': 'odometer',  // OLD FORMAT (actual field name)
        'tech': 'tech',
        'input_tech': 'tech',  // OLD FORMAT
        'inspection': 'inspection',
        'input_inspection': 'inspection',  // OLD FORMAT
        'date_in': 'date_in',
        'input_date_in': 'date_in',  // OLD FORMAT
        'date_out': 'date_out',
        'input_date_out': 'date_out',  // OLD FORMAT
        
        // Customer fields
        'customer_name': 'customer_name',
        'input_customer_name': 'customer_name',  // OLD FORMAT
        'customer_address': 'customer_address',
        'input_address': 'customer_address',  // OLD FORMAT
        'customer_phone': 'customer_phone',
        'input_phone_number': 'customer_phone',  // OLD FORMAT (if it exists)
        'phone_number': 'customer_phone',  // NEW FORMAT from mobile
        'vin_number': 'vin_number',
        'input_vin_number': 'vin_number',  // OLD FORMAT
        'mfg_date': 'mfg_date',
        'input_mfg_date': 'mfg_date',  // OLD FORMAT
        'county': 'county',
        'input_county': 'county',  // OLD FORMAT
        
        // Vehicle fields
        'year': 'year',
        'input_year': 'year',  // OLD FORMAT (if split fields existed)
        'make': 'make',
        'input_make': 'make',  // OLD FORMAT (if split fields existed)
        'model': 'model',
        'input_model': 'model',  // OLD FORMAT (if split fields existed)
        'trim': 'trim',
        'input_trim': 'trim',  // OLD FORMAT (if split fields existed)
        'engine_size': 'engine_size',
        'input_engine_size': 'engine_size',  // OLD FORMAT
        
        // Description
        'description': 'description',
        'input_description_of_work': 'description',  // OLD FORMAT
        
        // Tire fields
        'tire_lf': 'tire_lf',
        'input_tire_tread_lf': 'tire_lf',  // OLD FORMAT
        'tire_rf': 'tire_rf',
        'input_tire_tread_rf': 'tire_rf',  // OLD FORMAT
        'tire_lr': 'tire_lr',
        'input_tire_tread_lr': 'tire_lr',  // OLD FORMAT
        'tire_rr': 'tire_rr',
        'input_tire_tread_rr': 'tire_rr',  // OLD FORMAT
        'pressure_front': 'pressure_front',
        'input_tire_psi_front': 'pressure_front',  // OLD FORMAT
        'pressure_rear': 'pressure_rear',
        'input_tire_psi_rear': 'pressure_rear',  // OLD FORMAT
        
        // Brake fields
        'brake_lf': 'brake_lf',
        'input_brakes_lf': 'brake_lf',  // OLD FORMAT
        'brake_rf': 'brake_rf',
        'input_brakes_rf': 'brake_rf',  // OLD FORMAT
        'brake_lr': 'brake_lr',
        'input_brakes_lr': 'brake_lr',  // OLD FORMAT
        'brake_rr': 'brake_rr',
        'input_brakes_rr': 'brake_rr',  // OLD FORMAT
        
        // Oil change fields
        'oil_last_change': 'oil_last_change',
        'input_oil_last_change': 'oil_last_change',  // OLD FORMAT
        'oil_next_change': 'oil_next_change',
        'input_oil_next_change': 'oil_next_change',  // OLD FORMAT
        
        // State inspection fields
        'si_expires': 'si_expires',
        'input_si_expires': 'si_expires',  // OLD FORMAT (if it exists)
        'input_new_s_i_exp': 'si_expires',  // OLD FORMAT (actual field name)
        'si_mileage': 'si_mileage',
        'input_si_mileage': 'si_mileage',  // OLD FORMAT (if it exists)
        'input_new_s_i_date': 'si_mileage',  // OLD FORMAT (actual field name)
        'old_si_exp': 'old_si_exp',
        'input_old_s_i_exp_date': 'old_si_exp',  // OLD FORMAT
        'old_si_miles': 'old_si_miles',
        'input_old_s_i_miles': 'old_si_miles',  // OLD FORMAT
        
        // Labor timer fields (from mobile)
        'labor_hours': 'labor_hours',
        'tech_notes': 'tech_notes',
        
        // Pricing fields
        'parts_subtotal': 'parts_subtotal',
        'input_parts_subtotal': 'parts_subtotal',  // OLD FORMAT
        'labor_cost': 'labor_cost',
        'input_labor_cost': 'labor_cost',  // OLD FORMAT
        'shop_fees': 'shop_fees',
        'input_shop_fees': 'shop_fees',  // OLD FORMAT
        'tax_amount': 'tax_amount',
        'input_tax_amount': 'tax_amount',  // OLD FORMAT
        'grand_total': 'grand_total',
        'input_grand_total': 'grand_total'  // OLD FORMAT
    };
    
    // Populate regular text fields using mapping
    Object.keys(fieldMapping).forEach(function(firebaseKey) {
        const fieldId = fieldMapping[firebaseKey];
        const field = document.getElementById(fieldId);
        
        if (field && entry[firebaseKey] !== undefined) {
            if (field.tagName === 'TEXTAREA') {
                field.value = entry[firebaseKey];
            } else if (field.tagName === 'INPUT') {
                field.value = entry[firebaseKey];
            }
        }
    });
    
    // RO number fallback: if not in data, use currentEditKey (the database KEY)
    const roField = document.getElementById('ro_number');
    if (roField && !roField.value && currentEditKey) {
        roField.value = currentEditKey;
    }
    
    // Handle combined year_make_model_trim field from old format
    if (entry.input_year_make_model_trim) {
        const combined = entry.input_year_make_model_trim;
        // Try to parse "2012 audi a6 prestige" format
        const parts = combined.trim().split(/\s+/);
        if (parts.length >= 3) {
            const yearField = document.getElementById('year');
            const makeField = document.getElementById('make');
            const modelField = document.getElementById('model');
            const trimField = document.getElementById('trim');
            
            if (yearField && !yearField.value) yearField.value = parts[0];
            if (makeField && !makeField.value) makeField.value = parts[1];
            if (modelField && !modelField.value) modelField.value = parts[2];
            if (trimField && !trimField.value && parts.length > 3) {
                trimField.value = parts.slice(3).join(' ');
            }
            console.log(`âœ“ Parsed combined field: ${combined}`);
        }
    }
    
    // Populate parts table (qty, part, price, labor for rows 1-22)
    // Support both OLD format (input_pn1, input_q1) and NEW format (part1, qty1)
    for (let i = 1; i <= 22; i++) {
        // Quantity - try new format first, then old format
        const qtyField = document.getElementById('qty' + i);
        if (qtyField) {
            if (entry['qty' + i] !== undefined) {
                qtyField.value = entry['qty' + i];
            } else if (entry['input_q' + i] !== undefined) {
                qtyField.value = entry['input_q' + i];  // OLD FORMAT
            }
        }
        
        // Part number - try new format first, then old format
        const partField = document.getElementById('part' + i);
        if (partField) {
            if (entry['part' + i] !== undefined) {
                partField.value = entry['part' + i];
            } else if (entry['input_pn' + i] !== undefined) {
                partField.value = entry['input_pn' + i];  // OLD FORMAT
            }
        }
        
        // Price - try new format first, then old format
        const priceField = document.getElementById('price' + i);
        if (priceField) {
            if (entry['price' + i] !== undefined && entry['price' + i] !== '') {
                priceField.value = entry['price' + i];
            } else if (entry['input_price' + i] !== undefined && entry['input_price' + i] !== '') {
                priceField.value = entry['input_price' + i];  // OLD FORMAT
            }
        }
        
        // Labor hours - try new format first, then old format
        const laborField = document.getElementById('labor' + i);
        if (laborField) {
            if (entry['labor' + i] !== undefined && entry['labor' + i] !== '') {
                laborField.value = entry['labor' + i];
            } else if (entry['input_labor' + i] !== undefined && entry['input_labor' + i] !== '') {
                laborField.value = entry['input_labor' + i];  // OLD FORMAT
            }
        }
    }
    
    // Populate checkboxes - support both old and new formats
    const form = document.getElementById('repair-order-form');
    form.querySelectorAll('input[type="checkbox"]').forEach(function(el) {
        const checkboxId = el.id;
        let isChecked = false;
        
        // Try current ID, then try with "input_chk_" prefix for old format
        if (checkboxId && entry[checkboxId] !== undefined) {
            isChecked = entry[checkboxId];
        } else if (checkboxId && entry['input_chk_' + checkboxId.replace('em_', '')] !== undefined) {
            isChecked = entry['input_chk_' + checkboxId.replace('em_', '')];  // OLD FORMAT
        }
        
        el.checked = isChecked;
        // Update the visual state of custom checkboxes
        const div = el.closest('.form-field-custom-checkbox');
        if (div) {
            if (el.checked) {
                div.classList.add('checked');
            } else {
                div.classList.remove('checked');
            }
        }
    });
    
    // Update VIN field - support both old and new formats
    const vinField = document.getElementById('vin_number');
    if (vinField) {
        if (entry.vin_number !== undefined) {
            vinField.value = entry.vin_number;
        } else if (entry.input_vin_number !== undefined) {
            vinField.value = entry.input_vin_number;  // OLD FORMAT
        }
    }
    
    // Update labor timer widget
    const laborHoursDisplay = document.getElementById('labor_hours_display');
    const techNotesWidget = document.getElementById('tech_notes_widget');
    
    if (laborHoursDisplay) {
        const laborHours = entry.labor_hours || '0.0';
        laborHoursDisplay.textContent = laborHours + ' hrs';
    }
    
    if (techNotesWidget) {
        techNotesWidget.value = entry.tech_notes || '';
    }
    
    // Update timestamp
    lastKnownTimestamp = entry.timestamp;
    
    // Show reload status
    document.getElementById('save-status').textContent = 'Work order loaded successfully';
    document.getElementById('save-status').style.color = '#00ff88';
    setTimeout(function() { 
        if (currentLockStatus === 'locked-by-me') {
            document.getElementById('save-status').textContent = 'âœï¸ You are editing';
        } else {
            document.getElementById('save-status').textContent = '';
        }
    }, 2000);
}

// Clear all parts and quantities fields
function clearPartsFields() {
    // Clear quantities (qty1 through qty22)
    for (let i = 1; i <= 22; i++) {
        const qField = document.getElementById('qty' + i);
        if (qField) qField.value = '';  // Use .value for input fields
    }
    // Clear part numbers (part1 through part22)
    for (let i = 1; i <= 22; i++) {
        const pnField = document.getElementById('part' + i);
        if (pnField) pnField.value = '';  // Use .value for input fields
    }
    // Clear prices (price1 through price22)
    for (let i = 1; i <= 22; i++) {
        const priceField = document.getElementById('price' + i);
        if (priceField) priceField.value = '';
    }
    // Clear labor hours (labor1 through labor22)
    for (let i = 1; i <= 22; i++) {
        const laborField = document.getElementById('labor' + i);
        if (laborField) laborField.value = '';
    }
}

// Set default emissions checkboxes
function setDefaultCheckboxes() {
    // This function is kept for compatibility but may not find checkboxes depending on your form
    // Only the em_pass checkbox exists in the current form
    const checkbox = document.getElementById('em_pass');
    if (checkbox) {
        checkbox.checked = false; // Don't auto-check by default
    }
}

// Make emissions checkboxes mutually exclusive (only one can be checked at a time)
const emissionsCheckboxes = ['em_pass', 'em_fail', 'em_waived', 'em_exempt'];
emissionsCheckboxes.forEach(function(checkboxId) {
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                // Uncheck all other emissions checkboxes
                emissionsCheckboxes.forEach(function(otherId) {
                    if (otherId !== checkboxId) {
                        const otherCheckbox = document.getElementById(otherId);
                        if (otherCheckbox) {
                            otherCheckbox.checked = false;
                        }
                    }
                });
            }
        });
    }
});

// Firefox form clearing on page load/refresh (Firefox caches form values)
const form = document.getElementById('repair-order-form');
if (form) {
    // Clear all text inputs
    form.querySelectorAll('input[type="text"], input[type="number"], input[type="tel"], input[type="email"]').forEach(input => {
        input.value = '';
    });
    
    // Clear textareas
    form.querySelectorAll('textarea').forEach(textarea => {
        textarea.value = '';
    });
    
    // Clear contenteditable elements
    form.querySelectorAll('[contenteditable]').forEach(el => {
        el.textContent = '';
        el.innerHTML = '';
    });
    
    // Clear checkboxes
    form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Clear custom checkboxes
    document.querySelectorAll('.form-field-custom-checkbox').forEach(div => {
        div.classList.remove('checked');
    });
}

// Clear dropdown
const dropdown = document.getElementById('entries-dropdown');
if (dropdown) dropdown.value = '';

// Set current date when page loads
setCurrentDate();

// Clear parts fields on page load
clearPartsFields();

// Set default checkboxes for new work orders
setDefaultCheckboxes();

// Generate initial work order number after Firebase is ready
setTimeout(function() {
    generateNextWorkOrderNumber();
}, 1000);

// Helper function to normalize strings by removing special characters for searching
function normalizeForSearch(str) {
    if (!str) return '';
    return str.toLowerCase()
        .replace(/[^a-z0-9\s]/gi, '') // Remove all special characters except spaces
        .replace(/\s+/g, ' ')         // Replace multiple spaces with single space
        .trim();                      // Remove leading/trailing spaces
}

function renderDropdown(entries, filter = '') {
    entriesDropdown.innerHTML = '<option value="">Select a saved entry...</option>';
    if (!entries || Object.keys(entries).length === 0) {
        entriesDropdown.innerHTML += '<option disabled>No saved entries</option>';
        return;
    }
    
    // Sort entries by date field only (newest first)
    const sortedEntries = Object.entries(entries).sort((a, b) => {
        // Helper function to parse date strings in MM/DD/YYYY format
        const parseDate = (dateStr) => {
            if (!dateStr) return 0;
            const trimmed = dateStr.trim();
            const parts = trimmed.split('/');
            if (parts.length === 3) {
                // MM/DD/YYYY format - parse carefully for Firefox compatibility
                const month = parseInt(parts[0], 10);
                const day = parseInt(parts[1], 10);
                const year = parseInt(parts[2], 10);
                // Validate parsed values
                if (!isNaN(month) && !isNaN(day) && !isNaN(year)) {
                    const dateObj = new Date(year, month - 1, day);
                    // Verify the date is valid
                    if (dateObj.getFullYear() === year && dateObj.getMonth() === month - 1 && dateObj.getDate() === day) {
                        return dateObj.getTime();
                    }
                }
            }
            // Fallback
            const fallbackDate = new Date(trimmed);
            return isNaN(fallbackDate.getTime()) ? 0 : fallbackDate.getTime();
        };
        
        // Use only the date field for sorting
        const aTime = parseDate(a[1].input_date || '');
        const bTime = parseDate(b[1].input_date || '');
        
        // If times are equal, use work order number as tiebreaker (newer WO numbers are higher)
        if (aTime === bTime) {
            const aWO = a[0] || '';
            const bWO = b[0] || '';
            return bWO.localeCompare(aWO);
        }
        
        return bTime - aTime; // Descending order (newest first)
    });
    
    sortedEntries.forEach(([key, entry]) => {
        const yearMakeModel = entry.input_year_make_model_trim || '';
        const customerName = entry.input_customer_name || '';
        const vinNumber = entry.input_vin_number || '';
        const plateNumber = entry.input_plate_number || '';
        const date = entry.input_date || '';
        
        // Create multi-line label with emojis and last 8 digits of VIN
        let label = `ðŸ“… ${date}\n`;
        if (vinNumber) {
            // Get last 8 digits of VIN
            const shortVin = vinNumber.length > 8 ? vinNumber.slice(-8).toUpperCase() : vinNumber.toUpperCase();
            label += `ðŸ‘¤ ${customerName.toUpperCase()} â€¢ ðŸ”‘ ${shortVin}\n`;
        } else {
            label += `ðŸ‘¤ ${customerName.toUpperCase()}\n`;
        }
        label += `ðŸš— ${yearMakeModel.toUpperCase()}`;
        
        // Include all searchable fields in search string
        const searchString = `${customerName} ${yearMakeModel} ${vinNumber} ${plateNumber} ${date}`;
        
        // Normalize both the search string and filter for comparison (ignore special characters)
        const normalizedSearchString = normalizeForSearch(searchString);
        const normalizedFilter = normalizeForSearch(filter);
        
        if (normalizedSearchString.includes(normalizedFilter)) {
            entriesDropdown.innerHTML += `<option value="${key}">${label}</option>`;
        }
    });
}

// Generate next sequential work order number
// Generate work order number in format MMYYNNN (Month, Year, Counter)
async function generateNextWorkOrderNumber() {
    try {
        const roField = document.getElementById('ro_number');
        if (!roField) return;
        
        const now = new Date();
        const month = String(now.getMonth() + 1).padStart(2, '0'); // 01-12
        const year = String(now.getFullYear()).slice(-2); // Last 2 digits of year
        const prefix = month + year; // e.g., "1025" for October 2025
        
        const snapshot = await db.ref('repairOrders').once('value');
        let maxCounter = 0;
        
        // Find the highest counter for this month/year
        snapshot.forEach((child) => {
            const woNum = child.key;
            // Check if it matches our format (starts with current month/year prefix)
            if (woNum && woNum.startsWith(prefix)) {
                const counter = parseInt(woNum.slice(4), 10); // Get last 3 digits
                if (!isNaN(counter) && counter > maxCounter) {
                    maxCounter = counter;
                }
            }
        });
        
        // Increment and format as 3-digit counter
        const nextCounter = String(maxCounter + 1).padStart(3, '0');
        const nextNumber = prefix + nextCounter; // e.g., "1025001"
        
        roField.value = nextNumber;
        console.log('Generated work order number:', nextNumber);
        return nextNumber;
    } catch (error) {
        console.error('Error generating work order number:', error);
        // Fallback: use current month/year + 001
        const now = new Date();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const year = String(now.getFullYear()).slice(-2);
        return month + year + '001';
    }
}

function fetchEntries() {
    db.ref('repairOrders').on('value', function(snapshot) {
        entriesCache = snapshot.val() || {};
        renderDropdown(entriesCache, entrySearch.value);
    });
}
// Don't call fetchEntries() here - it's called after authentication in initializeApp()

entrySearch.addEventListener('input', function() {
    renderDropdown(entriesCache, entrySearch.value);
    // Auto-open dropdown when searching
    if (entrySearch.value.length > 0) {
        entriesDropdown.size = Math.min(entriesDropdown.options.length, 8); // Show up to 8 options
    } else {
        entriesDropdown.size = 1; // Reset to normal size when search is cleared
    }
});

// Auto-open dropdown when focusing on search box
entrySearch.addEventListener('focus', function() {
    if (Object.keys(entriesCache).length > 0) {
        renderDropdown(entriesCache, entrySearch.value);
        entriesDropdown.size = Math.min(entriesDropdown.options.length, 8); // Show up to 8 options
    }
});

// Reset dropdown size when it loses focus
entriesDropdown.addEventListener('blur', function() {
    setTimeout(() => {
        entriesDropdown.size = 1; // Reset to normal size
    }, 200); // Small delay to allow selection
});

entriesDropdown.addEventListener('change', function(e) {
    const key = entriesDropdown.value;
    
    // Check for force unlock (Ctrl+Shift held during selection)
    const forceUnlock = e.ctrlKey && e.shiftKey;
    if (!key || !entriesCache[key]) {
        // Release lock on previous work order
        if (currentWorkOrderNumber) {
            releaseLock(currentWorkOrderNumber);
        }
        
        stopWatchingWorkOrder(); // Stop watching when clearing
        currentEditKey = null;
        currentWorkOrderNumber = null; // Reset work order tracking
        currentLockStatus = 'unlocked'; // Reset lock status
        
        deleteEntryBtn.style.display = 'none';
        newOrderBtn.style.display = 'none';
        saveBtn.textContent = 'Save';
        document.getElementById('save-status').textContent = '';
        document.getElementById('save-status').classList.remove('locked-readonly');
        
        // Hide force unlock button
        const forceUnlockBtn = document.getElementById('force-unlock-btn');
        if (forceUnlockBtn) {
            forceUnlockBtn.classList.remove('visible');
        }
        
        document.getElementById('repair-order-form').reset();
        clearPartsFields(); // Clear parts fields
        // Reset custom checkbox visual states
        document.querySelectorAll('.form-field-custom-checkbox').forEach(function(div) {
            div.classList.remove('checked');
        });
        const vinField = document.getElementById('vin_number');
        if (vinField) vinField.value = '';
        return;
    }
    const entry = entriesCache[key];
    
    // Stop watching previous work order (also stops heartbeat)
    stopWatchingWorkOrder();
    
    // Always clean up previous state first
    const previousWO = currentWorkOrderNumber;
    const hadLock = currentLockStatus === 'locked-by-me';
    
    if (DEBUG_LOCK_MODE && previousWO) {
        console.log(`ðŸ”„ Switching from WO ${previousWO} (hadLock: ${hadLock}) to ${key}`);
    }
    
    // Reset state immediately (Edge: clear everything before new operations)
    currentLockStatus = 'unlocked';
    currentWorkOrderNumber = null;
    currentEditKey = null;
    
    // Hide force unlock button
    const forceUnlockBtn = document.getElementById('force-unlock-btn');
    if (forceUnlockBtn) {
        forceUnlockBtn.classList.remove('visible');
    }
    
    // Clear status
    document.getElementById('save-status').textContent = '';
    document.getElementById('save-status').classList.remove('locked-readonly');
    
    // Release lock ONLY if we had one and it's a different work order
    const releasePromise = (hadLock && previousWO && previousWO !== key) 
        ? releaseLock(previousWO).then(() => {
            if (DEBUG_LOCK_MODE) console.log('ðŸ”“ Released previous lock, waiting for propagation...');
            // Small delay to ensure Firebase has processed the release
            return new Promise(resolve => setTimeout(resolve, 100));
        })
        : Promise.resolve();
    
    // Wait for release to complete before acquiring new lock
    releasePromise.then(() => {
        // Reset form to clean state before attempting lock
        const form = document.getElementById('repair-order-form');
        form.querySelectorAll('input, textarea, [contenteditable]').forEach(el => {
            if (el.hasAttribute('contenteditable')) {
                el.setAttribute('contenteditable', 'true');
                el.style.backgroundColor = '';
                el.style.cursor = '';
            } else {
                el.disabled = false;
            }
        });
        form.querySelectorAll('.form-field-custom-checkbox').forEach(el => {
            el.style.pointerEvents = '';
            el.style.opacity = '';
        });
        
        // Try to acquire lock (with force option)
        return acquireLock(key, forceUnlock);
    }).then(() => {
        // Lock acquired successfully - NOW set current work order
        currentEditKey = key;
        currentWorkOrderNumber = key;
        currentLockStatus = 'locked-by-me';
        
        if (forceUnlock && DEBUG_LOCK_MODE) {
            console.log('âš ï¸ FORCE UNLOCK used - lock taken over');
        }
        
        // Load the data in edit mode
        loadWorkOrderData(entry);
        
        saveBtn.textContent = 'Update';
        saveBtn.disabled = false;
        deleteEntryBtn.style.display = 'inline-block';
        deleteEntryBtn.disabled = false;
        newOrderBtn.style.display = 'inline-block';
        newOrderBtn.disabled = false;
        document.getElementById('print-btn').disabled = false;
        
        document.getElementById('save-status').textContent = 'âœï¸ You are editing';
        document.getElementById('save-status').style.color = '#00ff88';
        document.getElementById('save-status').classList.remove('locked-readonly');
        
        // Hide force unlock button
        document.getElementById('force-unlock-btn').classList.remove('visible');
        
        // Start watching for real-time updates (small delay for Edge to process state)
        setTimeout(() => startWatchingWorkOrder(key), 50);
    }).catch(error => {
        if (error.locked) {
            // Locked by someone else - load in read-only mode
            // State already cleared above - don't set currentWorkOrderNumber
            // This prevents us from trying to release a lock we don't own next time
            
            loadWorkOrderData(entry);
            
            saveBtn.textContent = 'Update';
            deleteEntryBtn.style.display = 'inline-block';
            newOrderBtn.style.display = 'inline-block';
            
            // Disable form (this sets currentLockStatus = 'locked-by-other')
            disableForm(error.lockedBy);
            
            // Start watching for real-time updates (small delay for Edge to process state)
            setTimeout(() => startWatchingWorkOrder(key), 50);
            
            if (DEBUG_LOCK_MODE) console.log('ðŸ“– Viewing WO', key, 'in read-only mode (no lock owned)');
        } else {
            console.error('Error acquiring lock:', error);
            document.getElementById('save-status').textContent = 'Error: ' + error;
            document.getElementById('save-status').style.color = '#dc3545';
        }
    });
});

deleteEntryBtn.addEventListener('click', function() {
    if (!currentEditKey) return;
    if (!confirm('Delete this entry?')) return;
    
    // Release lock before deleting
    releaseLock(currentEditKey).then(() => {
        db.ref('repairOrders/' + currentEditKey).remove(function(error) {
            if (error) {
                alert('Error deleting entry!');
            } else {
                deleteEntryBtn.style.display = 'none';
                newOrderBtn.style.display = 'none';
                entriesDropdown.value = '';
                currentEditKey = null;
                currentWorkOrderNumber = null;
                saveBtn.textContent = 'Save';
                document.getElementById('save-status').textContent = 'Entry deleted.';
                clearPartsFields();
                const vinField = document.getElementById('vin_number');
                if (vinField) vinField.value = '';
            }
        });
    });
});

// New Work Order button functionality
document.getElementById('new-work-order-btn').addEventListener('click', async function() {
    if (!confirm('Create a completely new work order? This will clear all current data.')) return;
    
    // Release lock on current work order
    if (currentWorkOrderNumber) {
        await releaseLock(currentWorkOrderNumber);
    }
    
    // Reset the entire form
    const form = document.getElementById('repair-order-form');
    form.reset();
    clearPartsFields(); // Clear parts fields
    
    // Reset custom checkbox visual states
    document.querySelectorAll('.form-field-custom-checkbox').forEach(function(div) {
        div.classList.remove('checked');
    });
    
    // Reset VIN field
    const vinField = document.getElementById('vin_number');
    if (vinField) vinField.value = '';
    
    // Set current date
    setCurrentDate();
    
    // Set default checkboxes
    setDefaultCheckboxes();
    
    // Generate next work order number
    await generateNextWorkOrderNumber();
    
    // Reset UI state
    currentEditKey = null;
    currentWorkOrderNumber = null; // Reset work order tracking
    currentLockStatus = 'unlocked';
    saveBtn.textContent = 'Save';
    entriesDropdown.value = '';
    entrySearch.value = '';
    deleteEntryBtn.style.display = 'none';
    newOrderBtn.style.display = 'none';
    document.getElementById('save-status').textContent = 'New work order ready';
    
    // Enable form
    enableForm();
    
    setTimeout(function() { document.getElementById('save-status').textContent = ''; }, 3000);
});

// New Order (Same Customer) button functionality
newOrderBtn.addEventListener('click', async function() {
    if (!confirm('Create a new work order using the current customer and vehicle information?')) return;
    
    // Release lock on current work order
    if (currentWorkOrderNumber) {
        await releaseLock(currentWorkOrderNumber);
    }
    
    // Store customer and vehicle info by ID
    const customerInfo = {};
    
    // Fields to preserve (customer and vehicle info) - using IDs
    const preserveFieldIds = [
        'customer_name', 'customer_phone', 'customer_address',
        'vin_number', 'plate', 'year', 'make', 'model', 'trim',
        'engine_size', 'pressure_front', 'pressure_rear'
    ];
    
    preserveFieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            customerInfo[fieldId] = field.value;
        }
    });
    
    // Reset the form
    const form = document.getElementById('repair-order-form');
    form.reset();
    
    // Explicitly clear all inputs except those we want to preserve
    form.querySelectorAll('input[type="text"], textarea').forEach(input => {
        if (!preserveFieldIds.includes(input.id)) {
            input.value = '';
        }
    });
    
    clearPartsFields(); // Clear parts fields
    
    // Clear checkboxes
    form.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
        cb.checked = false;
    });
    document.querySelectorAll('.form-field-custom-checkbox').forEach(function(div) {
        div.classList.remove('checked');
    });
    
    // Restore customer and vehicle info
    preserveFieldIds.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && customerInfo[fieldId]) {
            field.value = customerInfo[fieldId];
        }
    });
    
    // Set current date
    setCurrentDate();
    
    // Set default checkboxes
    setDefaultCheckboxes();
    
    // Generate next work order number
    await generateNextWorkOrderNumber();
    
    // Reset UI state
    currentEditKey = null;
    currentWorkOrderNumber = null;
    currentWatchingWorkOrder = null;
    currentLockStatus = 'unlocked';
    saveBtn.textContent = 'Save';
    entriesDropdown.value = '';
    deleteEntryBtn.style.display = 'none';
    newOrderBtn.style.display = 'none';
    
    // Stop watching old work order
    stopWatchingWorkOrder();
    
    // Enable form
    enableForm();
    
    document.getElementById('save-status').textContent = 'New order ready for same customer/vehicle';
    setTimeout(function() { document.getElementById('save-status').textContent = ''; }, 3000);
});

// Track active lock in sessionStorage for cleanup on refresh
function trackActiveLock() {
    if (currentWorkOrderNumber && currentLockStatus === 'locked-by-me') {
        sessionStorage.setItem('activeLock_' + myDeviceId, JSON.stringify({
            workOrder: currentWorkOrderNumber,
            timestamp: Date.now()
        }));
    } else {
        sessionStorage.removeItem('activeLock_' + myDeviceId);
    }
}

// Clean up any lock from previous page session (handles refresh/crash)
function cleanupPreviousLock() {
    const storageKey = 'activeLock_' + myDeviceId;
    const activeLock = sessionStorage.getItem(storageKey);
    if (activeLock) {
        try {
            const lockData = JSON.parse(activeLock);
            // Clean up lock from previous session (less than 10 minutes old to be safe)
            if (lockData.workOrder && (Date.now() - lockData.timestamp) < 600000) {
                if (DEBUG_LOCK_MODE) console.log('ðŸ§¹ Cleaning up lock from previous session:', lockData.workOrder);
                // Release the lock immediately
                db.ref('repairOrders/' + lockData.workOrder + '/lockedBy').remove();
                db.ref('repairOrders/' + lockData.workOrder + '/lockedByName').remove();
                db.ref('repairOrders/' + lockData.workOrder + '/lockHeartbeat').remove();
                db.ref('repairOrders/' + lockData.workOrder + '/lockedAt').remove();
            }
        } catch (e) {
            console.error('Error cleaning up previous lock:', e);
        }
        sessionStorage.removeItem(storageKey);
    }
}

// Run cleanup immediately on page load
setTimeout(() => cleanupPreviousLock(), 1000);

// Release lock when browser closes (multiple events for cross-browser compatibility)
const releaseOnClose = function(e) {
    if (currentWorkOrderNumber && currentLockStatus === 'locked-by-me') {
        // Synchronous release attempt
        releaseLock(currentWorkOrderNumber);
        sessionStorage.removeItem('activeLock_' + myDeviceId);
        if (DEBUG_LOCK_MODE) console.log('ðŸšª Browser closing - releasing lock');
    }
};

window.addEventListener('beforeunload', releaseOnClose);
// pagehide is more reliable in Firefox than beforeunload
window.addEventListener('pagehide', releaseOnClose);

// Pause/resume heartbeat when tab visibility changes (mobile/background)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // Tab hidden - stop heartbeat to save battery/bandwidth
        // Lock will expire after 90 seconds if tab stays hidden
        if (currentWorkOrderNumber && currentLockStatus === 'locked-by-me') {
            stopHeartbeat();
            if (DEBUG_LOCK_MODE) console.log('ðŸ‘ï¸ Tab hidden - pausing heartbeat (lock will expire in 90s)');
        }
    } else if (!document.hidden) {
        // Tab visible again - check if we still have the lock
        if (currentWorkOrderNumber && currentLockStatus === 'locked-by-me') {
            // Verify lock is still ours before resuming heartbeat
            db.ref('repairOrders/' + currentWorkOrderNumber + '/lockedBy').once('value').then(snapshot => {
                const lockedBy = snapshot.val();
                if (lockedBy === myDeviceId) {
                    // Still ours - resume heartbeat
                    startHeartbeat(currentWorkOrderNumber);
                    if (DEBUG_LOCK_MODE) console.log('ðŸ‘ï¸ Tab visible - resuming heartbeat');
                } else {
                    // Lost the lock while hidden
                    currentLockStatus = 'unlocked';
                    if (DEBUG_LOCK_MODE) console.log('âš ï¸ Lost lock while tab was hidden');
                }
            });
        }
    }
});

// Force unlock button
document.getElementById('force-unlock-btn').addEventListener('click', function() {
    // Use currentWatchingWorkOrder (set even in read-only) instead of currentWorkOrderNumber
    const woNumber = currentWatchingWorkOrder || currentWorkOrderNumber;
    
    if (!woNumber) {
        alert('No work order selected');
        return;
    }
    
    if (confirm('Force unlock this work order? This will override the current lock.')) {
        // Force acquire lock
        acquireLock(woNumber, true).then(() => {
            currentWorkOrderNumber = woNumber;
            currentLockStatus = 'locked-by-me';
            enableForm();
            document.getElementById('save-status').textContent = 'âœ… Lock overridden - you can now edit';
            document.getElementById('save-status').style.color = '#00ff88';
            setTimeout(() => {
                document.getElementById('save-status').textContent = 'âœï¸ You are editing';
            }, 3000);
        }).catch(err => {
            alert('Failed to unlock: ' + (err.message || err));
        });
    }
});

// Save Company Info as Default
document.getElementById('save-company-btn').addEventListener('click', function() {
    if (!confirm('Save this as your company\'s default information? This can only be done once.')) {
        return;
    }
    
    const companyInfo = {
        company_name: document.getElementById('company_name').textContent || '',
        company_address: document.getElementById('company_address').textContent || '',
        company_contact: document.getElementById('company_contact').textContent || '',
        company_website: document.getElementById('company_website').textContent || ''
    };
    
    database.ref('shopSettings/' + companyId + '/companyInfo').set(companyInfo).then(() => {
        const status = document.getElementById('save-status');
        status.textContent = 'âœ… Company info saved as default!';
        status.style.color = '#00ff88';
        
        // Hide the button and hint permanently after saving
        document.getElementById('save-company-btn').style.display = 'none';
        document.getElementById('company-hint').style.display = 'none';
        
        setTimeout(() => {
            status.textContent = '';
        }, 3000);
    }).catch(err => {
        alert('Error saving company info: ' + err.message);
    });
});

saveBtn.addEventListener('click', function() {
    const form = document.getElementById('repair-order-form');
    const data = {};
    
    // Collect company info (contenteditable fields)
    data.company_name = document.getElementById('company_name').textContent || '';
    data.company_address = document.getElementById('company_address').textContent || '';
    data.company_contact = document.getElementById('company_contact').textContent || '';
    data.company_website = document.getElementById('company_website').textContent || '';
    
    // Collect all text inputs and textareas by their ID (NEW FORMAT)
    form.querySelectorAll('input[type="text"], textarea').forEach(function(el) {
        if (el.id && el.id !== '') {
            data[el.id] = el.value || '';
        }
    });
    
    // Collect all checkboxes by their ID (NEW FORMAT)
    form.querySelectorAll('input[type="checkbox"]').forEach(function(el) {
        if (el.id && el.id !== '') {
            data[el.id] = el.checked;
        }
    });
    
    // Collect labor timer widget data
    const techNotesWidget = document.getElementById('tech_notes_widget');
    if (techNotesWidget) {
        data.tech_notes = techNotesWidget.value || '';
    }
    
    // Note: labor_hours is read-only (comes from mobile timer), so we don't save it here
    // It will be preserved from existing data when updating
    
    // ADD OLD FORMAT FIELDS for backward compatibility with mobile and old system
    // Header fields
    data.input_date = data.date || '';
    data.input_ro = data.ro_number || '';
    data.input_stock_ = data.stock_number || '';
    data.input_plate_number = data.plate || '';
    data.input_odometer = data.odometer || '';
    data.input_tech = data.tech || '';
    data.input_inspection = data.inspection || '';
    data.input_date_in = data.date_in || '';
    data.input_date_out = data.date_out || '';
    
    // Customer fields
    data.input_customer_name = data.customer_name || '';
    data.input_address = data.customer_address || '';
    data.phone_number = data.customer_phone || '';  // Mobile uses phone_number
    data.input_vin_number = data.vin_number || '';
    data.input_county = data.county || '';
    
    // Vehicle fields - combine into old format
    const yearVal = data.year || '';
    const makeVal = data.make || '';
    const modelVal = data.model || '';
    const trimVal = data.trim || '';
    data.input_year_make_model_trim = `${yearVal} ${makeVal} ${modelVal} ${trimVal}`.trim();
    data.input_engine_size = data.engine_size || '';
    data.input_mfg_date = data.mfg_date || '';  // Add backward compatibility for mfg_date
    
    // Description
    data.input_description_of_work = data.description || '';
    
    // Tire fields
    data.input_tire_tread_lf = data.tire_lf || '';
    data.input_tire_tread_rf = data.tire_rf || '';
    data.input_tire_tread_lr = data.tire_lr || '';
    data.input_tire_tread_rr = data.tire_rr || '';
    data.input_tire_psi_front = data.pressure_front || '';
    data.input_tire_psi_rear = data.pressure_rear || '';
    
    // Brake fields
    data.input_brakes_lf = data.brake_lf || '';
    data.input_brakes_rf = data.brake_rf || '';
    data.input_brakes_lr = data.brake_lr || '';
    data.input_brakes_rr = data.brake_rr || '';
    
    // State inspection fields
    data.input_new_s_i_exp = data.si_expires || '';
    data.input_new_s_i_date = data.si_mileage || '';
    data.input_old_s_i_exp_date = data.old_si_exp || '';
    data.input_old_s_i_miles = data.old_si_miles || '';
    
    // Parts table - add old format (input_q1, input_pn1, etc.)
    for (let i = 1; i <= 22; i++) {
        if (data['qty' + i]) data['input_q' + i] = data['qty' + i];
        if (data['part' + i]) data['input_pn' + i] = data['part' + i];
        if (data['price' + i]) data['input_price' + i] = data['price' + i];
        if (data['labor' + i]) data['input_labor' + i] = data['labor' + i];
    }
    
    // Checkboxes - add old format with input_chk_ prefix
    const checkboxMapping = {
        'em_cat': 'input_chk_cat',
        'em_fuel_rest': 'input_chk_fuel_rest',
        'em_pcv': 'input_chk_pcv',
        'em_egr': 'input_chk_egr',
        'em_air': 'input_chk_air',
        'em_evap': 'input_chk_evap'
    };
    
    Object.keys(checkboxMapping).forEach(function(newKey) {
        const oldKey = checkboxMapping[newKey];
        if (data[newKey] !== undefined) {
            data[oldKey] = data[newKey];
        }
    });
    
    data.timestamp = new Date().toISOString();
    const status = document.getElementById('save-status');
    
    // Get work order number - use tracked number or from ro_number field
    const woNumber = currentWorkOrderNumber || data.ro_number;
    
    if (!woNumber) {
        status.textContent = 'Error: Work order number missing!';
        status.style.color = '#dc3545';
        return;
    }
    
    // Update our known timestamp before saving
    lastKnownTimestamp = data.timestamp;
    
    try {
        // Check if work order already exists
        db.ref('repairOrders/' + woNumber).once('value').then(function(snapshot) {
            const exists = snapshot.exists();
            const existingData = snapshot.val() || {};
            
            // Preserve labor_hours from mobile timer (don't overwrite with desktop data)
            if (existingData.labor_hours !== undefined) {
                data.labor_hours = existingData.labor_hours;
            }
            
            // Preserve lock data if we have it
            if (currentLockStatus === 'locked-by-me') {
                data.lockedBy = myDeviceId;
                data.lockedByName = myDeviceName;
                data.lockedAt = existingData.lockedAt || firebase.database.ServerValue.TIMESTAMP;
                data.lockHeartbeat = firebase.database.ServerValue.TIMESTAMP;
            }
            
            // Save all data
            db.ref('repairOrders/' + woNumber).set(data, function(error) {
                if (error) {
                    status.textContent = exists ? 'Error updating!' : 'Error saving!';
                    status.style.color = '#dc3545';
                } else {
                    // Track this work order for future updates
                    currentWorkOrderNumber = woNumber;
                    currentEditKey = woNumber;
                    
                    status.textContent = exists ? 'Updated!' : 'Saved!';
                    status.style.color = '#28a745';
                    setTimeout(function() { 
                        if (currentLockStatus === 'locked-by-me') {
                            status.textContent = 'âœï¸ You are editing';
                            status.style.color = '#00ff88';
                        } else {
                            status.textContent = '';
                        }
                    }, 2000);
                    
                    // Update button text to reflect we're now editing
                    if (!exists) {
                        saveBtn.textContent = 'Update';
                        deleteEntryBtn.style.display = 'inline-block';
                        newOrderBtn.style.display = 'inline-block';
                        
                        // Acquire lock and start watching this new work order
                        acquireLock(woNumber).then(() => {
                            startWatchingWorkOrder(woNumber);
                        });
                    }
                }
            });
        });
    } catch (e) {
        status.textContent = 'Save failed!';
        status.style.color = '#dc3545';
                console.error('Save button error:', e);
        }
    });
    </script>

    <script>
        // Labor Timer Widget Functionality
        let widgetSaveTimeout = null;
        
        // Toggle widget minimize/maximize
        function toggleWidget() {
            const widget = document.getElementById('labor-timer-widget');
            const btn = widget.querySelector('.minimize-btn');
            
            if (widget.classList.contains('minimized')) {
                widget.classList.remove('minimized');
                btn.textContent = 'âˆ’';
            } else {
                widget.classList.add('minimized');
                btn.textContent = 'â±';
            }
        }
        
        // Make widget draggable
        const widget = document.getElementById('labor-timer-widget');
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        
        const header = widget.querySelector('.widget-header');
        
        header.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', dragEnd);
        
        function dragStart(e) {
            // Don't drag if clicking minimize button
            if (e.target.classList.contains('minimize-btn')) return;
            
            initialX = e.clientX - xOffset;
            initialY = e.clientY - yOffset;
            
            if (e.target === header || e.target.tagName === 'H3') {
                isDragging = true;
            }
        }
        
        function drag(e) {
            if (isDragging) {
                e.preventDefault();
                
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;
                
                xOffset = currentX;
                yOffset = currentY;
                
                setTranslate(currentX, currentY, widget);
            }
        }
        
        function dragEnd(e) {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
        }
        
        function setTranslate(xPos, yPos, el) {
            el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`;
        }
        
        // Auto-save tech notes
        const techNotesWidget = document.getElementById('tech_notes_widget');
        const widgetSaveStatus = document.getElementById('widget_save_status');
        
        if (techNotesWidget) {
            techNotesWidget.addEventListener('input', function() {
                // Clear previous timeout
                if (widgetSaveTimeout) clearTimeout(widgetSaveTimeout);
                
                // Show typing indicator
                widgetSaveStatus.textContent = 'typing...';
                widgetSaveStatus.style.color = '#888';
                
                // Auto-save after 1 second of no typing
                widgetSaveTimeout = setTimeout(() => {
                    saveWidgetNotes();
                }, 1000);
            });
            
            // Also save on blur (when user clicks away)
            techNotesWidget.addEventListener('blur', function() {
                if (widgetSaveTimeout) clearTimeout(widgetSaveTimeout);
                saveWidgetNotes();
            });
        }
        
        function saveWidgetNotes() {
            const woNumber = currentWorkOrderNumber || currentEditKey;
            
            if (!woNumber) {
                widgetSaveStatus.textContent = '';
                return;
            }
            
            const notes = techNotesWidget.value || '';
            
            // Save just the tech_notes field (don't overwrite entire work order)
            db.ref('repairOrders/' + woNumber + '/tech_notes').set(notes).then(() => {
                widgetSaveStatus.textContent = 'âœ“ saved';
                widgetSaveStatus.style.color = '#00ff88';
                
                // Clear status after 2 seconds
                setTimeout(() => {
                    widgetSaveStatus.textContent = '';
                }, 2000);
            }).catch(err => {
                widgetSaveStatus.textContent = 'âœ— error';
                widgetSaveStatus.style.color = '#ff4757';
                console.error('Error saving notes:', err);
            });
        }
    </script>

</body>
</html>












